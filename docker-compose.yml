version: "3.8"
services:
  db:
    image: postgres:15-alpine
    container_name: streetfoodgo-db
    environment:
      POSTGRES_DB: streetfoodgo
      POSTGRES_USER: streetfoodgo
      POSTGRES_PASSWORD: streetfoodgo
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U streetfoodgo -d streetfoodgo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  hua-noc:
    build:
      context: ./services/Distributed-Systems-Project-NOC
      dockerfile: Dockerfile
    container_name: hua-noc-service
    environment:
      SERVER_PORT: 8080
    ports:
      - "8081:8080"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  # Self-hosted OSRM backend (no API key)
  osrm:
    image: ghcr.io/project-osrm/osrm-backend:latest
    container_name: streetfoodgo-osrm
    ports:
      - "5000:5000"
    volumes:
      - osrm-data:/data
    command: >
      bash -c "        if [ ! -f /data/greece-latest.osrm ]; then           wget -O /data/greece-latest.osm.pbf https://download.geofabrik.de/europe/greece-latest.osm.pbf &&           osrm-extract -p /opt/car.lua /data/greece-latest.osm.pbf &&           osrm-partition /data/greece-latest.osrm &&           osrm-customize /data/greece-latest.osrm;         fi &&         osrm-routed --algorithm mld /data/greece-latest.osrm"
    networks:
      - app-network

  # Self-hosted Photon geocoder (OpenSearch backend)
  photon:
    image: eclipse-temurin:21-jre
    container_name: streetfoodgo-photon
    environment:
      PHOTON_JAR_URL: https://github.com/komoot/photon/releases/download/0.7.0/photon-opensearch-0.7.0.jar
      # Greece extract dump (update URL if GraphHopper changes paths)
      PHOTON_DUMP_URL: https://download1.graphhopper.com/public/experimental/extracts/europe/greece-latest.tar.bz2
    ports:
      - "2322:2322"
    volumes:
      - photon-data:/photon/photon_data
    command: >
      bash -lc "        mkdir -p /photon && cd /photon &&         if [ ! -f /photon/photon.jar ]; then           wget -qO photon.jar ${PHOTON_JAR_URL};         fi;         if [ ! -f /photon/photon_data/READY ]; then           mkdir -p /photon/photon_data &&           wget -qO - ${PHOTON_DUMP_URL} | bzip2 -cd | tar x -C /photon &&           touch /photon/photon_data/READY;         fi;         java -Xms2G -Xmx4G -jar /photon/photon.jar -listen-port 2322 -data-dir /photon/photon_data"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:2322/status || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 20
      start_period: 60s
    networks:
      - app-network

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: streetfoodgo-app
    depends_on:
      db:
        condition: service_healthy
      hua-noc:
        condition: service_started
      osrm:
        condition: service_started
      photon:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/streetfoodgo
      SPRING_DATASOURCE_USERNAME: streetfoodgo
      SPRING_DATASOURCE_PASSWORD: streetfoodgo
      SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
      JWT_SECRET: Uh0WvRj5qs2sChP0dwTkky/VoudWSk0FVikEDDUKdRU=
      HUA_NOC_BASE_URL: http://hua-noc:8080
      # Geolocation (self-hosted OSRM + Photon)
      APP_GEO_ROUTING_BASE_URL: http://osrm:5000
      APP_GEO_GEOCODER: photon
      APP_GEO_GEOCODER_BASE_URL: http://photon:2322
    ports:
      - "8080:8080"
    networks:
      - app-network
    restart: on-failure:3

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: streetfoodgo-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@streetfoodgo.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - db
    networks:
      - app-network

volumes:
  db-data:
  osrm-data:
  photon-data:

networks:
  app-network:
    driver: bridge
