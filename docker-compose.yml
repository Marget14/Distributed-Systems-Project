services:
  db:
    image: postgres:15-alpine
    container_name: streetfoodgo-db
    environment:
      POSTGRES_DB: streetfoodgo
      POSTGRES_USER: streetfoodgo
      POSTGRES_PASSWORD: streetfoodgo
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U streetfoodgo -d streetfoodgo"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - app-network

  hua-noc:
    build:
      context: ./services/Distributed-Systems-Project-NOC
      dockerfile: Dockerfile
    container_name: hua-noc-service
    environment:
      SERVER_PORT: 8080
    ports:
      - "8081:8080"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/actuator/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 60s

  osrm:
    image: osrm/osrm-backend:latest
    container_name: streetfoodgo-osrm
    # Demo dataset (Monaco) - small and fast to bootstrap.
    # For real Greece data you can swap the PBF URL.
    volumes:
      - osrm-data:/data
    command: >
      sh -c "
        if [ ! -f /data/monaco.osrm ]; then
          echo 'Downloading Monaco OSM extract...';
          wget -q -O /data/monaco.osm.pbf https://download.geofabrik.de/europe/monaco-latest.osm.pbf;
          echo 'Extracting OSRM...';
          osrm-extract -p /opt/car.lua /data/monaco.osm.pbf;
          echo 'Partitioning...';
          osrm-partition /data/monaco.osrm;
          echo 'Customizing...';
          osrm-customize /data/monaco.osrm;
        fi;
        echo 'Starting OSRM routed...';
        osrm-routed --algorithm mld /data/monaco.osrm
      "
    ports:
      - "5000:5000"
    networks:
      - app-network

  redis:
    image: redis:7-alpine
    container_name: streetfoodgo-redis
    ports:
      - "6379:6379"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    volumes:
      - redis-data:/data

  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: streetfoodgo-app
    depends_on:
      db:
        condition: service_healthy
      hua-noc:
        condition: service_started
      osrm:
        condition: service_started
      redis:
        condition: service_healthy
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/streetfoodgo
      SPRING_DATASOURCE_USERNAME: streetfoodgo
      SPRING_DATASOURCE_PASSWORD: streetfoodgo
      SPRING_JPA_HIBERNATE_DDL_AUTO: create-drop
      JWT_SECRET: Uh0WvRj5qs2sChP0dwTkky/VoudWSk0FVikEDDUKdRU=
      HUA_NOC_BASE_URL: http://hua-noc:8080
      SPRING_REDIS_HOST: redis
      SPRING_REDIS_PORT: 6379
      APP_OSRM_BASE_URL: http://osrm:5000
    ports:
      - "8080:8080"
    networks:
      - app-network
    restart: on-failure:3

  pgadmin:
    image: dpage/pgadmin4:latest
    container_name: streetfoodgo-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@streetfoodgo.com
      PGADMIN_DEFAULT_PASSWORD: admin
      PGADMIN_CONFIG_SERVER_MODE: 'False'
    ports:
      - "5050:80"
    depends_on:
      - db
    networks:
      - app-network

volumes:
  db-data:
  redis-data:
  osrm-data:

networks:
  app-network:
    driver: bridge
