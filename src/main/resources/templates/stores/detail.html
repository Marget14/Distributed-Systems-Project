<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Store Details</title>
</head>
<body>
<div layout:fragment="main">
    <div id="storeData"
         th:data-store-id="${store.id()}"
         th:data-delivery-fee="${store.deliveryFee()}"
         th:data-min-order="${store.minimumOrderAmount()}">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Store Info & Menu Items -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Store Header -->
                <div class="glass-panel p-6">
                    <h1 class="text-3xl font-bold text-white mb-2" th:text="${store.name()}">Store</h1>
                    <p class="text-gray-400 mb-3" th:text="${store.description()}">Description</p>
                    <div class="flex gap-4 text-sm text-gray-400">
                        <span><i class="fas fa-clock mr-1"></i><span th:text="${store.estimatedDeliveryTimeMinutes()}">30</span> min</span>
                        <span><i class="fas fa-coins mr-1"></i>Min €<span th:text="${store.minimumOrderAmount()}">10</span></span>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="space-y-4">
                    <div th:each="item : ${menuItems}"
                         class="glass-panel p-4 menu-item">
                        <div class="flex justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-white" th:text="${item.name()}">Item</h3>
                                <p class="text-sm text-gray-400" th:text="${item.description()}">Desc</p>
                                <span class="text-xl text-cyber-blue font-bold">€<span th:text="${item.price()}">0</span></span>
                            </div>
                            <div th:if="${item.available()}">
                                <input type="hidden" class="item-id" th:value="${item.id()}"/>
                                <input type="hidden" class="item-name" th:value="${item.name()}"/>
                                <input type="hidden" class="item-price" th:value="${item.price()}"/>
                                <button class="add-btn cyber-button h-fit">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Cart -->
            <div class="lg:col-span-1">
                <div class="glass-panel p-6 sticky top-24">
                    <h2 class="text-xl font-bold text-white mb-4"><i class="fas fa-shopping-cart mr-2"></i>Cart</h2>

                    <div id="emptyCart" class="text-center py-8">
                        <i class="fas fa-shopping-cart text-4xl text-gray-600 mb-2"></i>
                        <p class="text-gray-400">Empty</p>
                    </div>

                    <div id="cartItems" class="hidden space-y-3 mb-4"></div>

                    <div id="cartSummary" class="hidden border-t border-white/10 pt-4">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-gray-300">
                                <span>Subtotal</span>
                                <span id="subtotal">€0</span>
                            </div>
                            <div class="flex justify-between text-gray-300">
                                <span>Delivery</span>
                                <span id="deliveryDisplay">€0</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-white">
                                <span>Total</span>
                                <span id="total">€0</span>
                            </div>
                        </div>
                        <button id="checkoutBtn" class="w-full cyber-button py-3 relative">
                            <i class="fas fa-shopping-bag mr-2"></i>Checkout
                            <span id="cartBadge" class="absolute -top-2 -right-2 w-6 h-6 bg-neon-pink rounded-full flex items-center justify-center text-xs font-bold">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="none">
        (function() {
            console.log('Script starting...');

            var cart = [];
            var config = {storeId: '', deliveryFee: 0, minOrder: 0};

            function init() {
                console.log('Initializing...');
                var el = document.getElementById('storeData');
                if (!el) {
                    console.error('storeData element not found!');
                    return;
                }

                config.storeId = el.dataset.storeId;
                config.deliveryFee = parseFloat(el.dataset.deliveryFee);
                config.minOrder = parseFloat(el.dataset.minOrder);
                console.log('Config:', config);

                loadCart();
                setupButtons();
            }

            function setupButtons() {
                var addButtons = document.querySelectorAll('.add-btn');
                console.log('Found buttons:', addButtons.length);

                addButtons.forEach(function(btn, index) {
                    console.log('Setting up button', index);
                    btn.addEventListener('click', function(e) {
                        console.log('Button clicked!');
                        e.preventDefault();
                        var container = this.parentElement;
                        var itemData = {
                            id: container.querySelector('.item-id').value,
                            name: container.querySelector('.item-name').value,
                            price: parseFloat(container.querySelector('.item-price').value),
                            quantity: 1
                        };
                        console.log('Item data:', itemData);
                        addToCart(itemData);
                    });
                });

                var checkoutBtn = document.getElementById('checkoutBtn');
                if (checkoutBtn) {
                    checkoutBtn.addEventListener('click', function() {
                        window.location.href = '/checkout?store=' + config.storeId;
                    });
                }
            }

            function addToCart(item) {
                console.log('Adding to cart:', item);
                var ex = cart.find(function(c) { return c.id === item.id; });
                if (ex) {
                    ex.quantity++;
                } else {
                    cart.push(item);
                }
                saveCart();
                renderCart();
                showNotification('Added ' + item.name + ' to cart!');
            }

            function removeItem(id) {
                cart = cart.filter(function(c) { return c.id !== id; });
                saveCart();
                renderCart();
            }

            window.removeItem = removeItem;

            function updateQty(id, d) {
                var item = cart.find(function(c) { return c.id === id; });
                if (item) {
                    item.quantity += d;
                    if (item.quantity <= 0) {
                        removeItem(id);
                    } else {
                        saveCart();
                        renderCart();
                    }
                }
            }

            window.updateQty = updateQty;

            function renderCart() {
                var empty = document.getElementById('emptyCart');
                var items = document.getElementById('cartItems');
                var summary = document.getElementById('cartSummary');

                if (cart.length === 0) {
                    empty.classList.remove('hidden');
                    items.classList.add('hidden');
                    summary.classList.add('hidden');
                    return;
                }

                empty.classList.add('hidden');
                items.classList.remove('hidden');
                summary.classList.remove('hidden');

                items.innerHTML = '';
                var subtotal = 0;

                cart.forEach(function(item) {
                    subtotal += item.price * item.quantity;
                    var div = document.createElement('div');
                    div.className = 'bg-white/5 rounded p-3';
                    div.innerHTML =
                        '<div class="flex justify-between mb-2">' +
                        '<span class="text-white text-sm">' + item.name + '</span>' +
                        '<button onclick="removeItem(\'' + item.id + '\')" class="text-red-400"><i class="fas fa-times"></i></button>' +
                        '</div>' +
                        '<div class="flex justify-between items-center">' +
                        '<div class="flex gap-2">' +
                        '<button onclick="updateQty(\'' + item.id + '\', -1)" class="w-7 h-7 bg-white/10 rounded text-white text-sm">-</button>' +
                        '<span class="w-7 text-center text-white text-sm">' + item.quantity + '</span>' +
                        '<button onclick="updateQty(\'' + item.id + '\', 1)" class="w-7 h-7 bg-white/10 rounded text-white text-sm">+</button>' +
                        '</div>' +
                        '<span class="text-white font-bold">€' + (item.price * item.quantity).toFixed(2) + '</span>' +
                        '</div>';
                    items.appendChild(div);
                });

                var total = subtotal + config.deliveryFee;
                document.getElementById('subtotal').textContent = '€' + subtotal.toFixed(2);
                document.getElementById('deliveryDisplay').textContent = '€' + config.deliveryFee.toFixed(2);
                document.getElementById('total').textContent = '€' + total.toFixed(2);

                var totalItems = cart.reduce(function(sum, item) { return sum + item.quantity; }, 0);
                document.getElementById('cartBadge').textContent = totalItems;
            }

            function saveCart() {
                try {
                    localStorage.setItem('cart_' + config.storeId, JSON.stringify(cart));
                    console.log('Cart saved:', cart);
                } catch (e) {
                    console.error('Failed to save cart:', e);
                }
            }

            function loadCart() {
                try {
                    var saved = localStorage.getItem('cart_' + config.storeId);
                    if (saved) {
                        cart = JSON.parse(saved);
                        console.log('Cart loaded:', cart);
                        renderCart();
                    }
                } catch (e) {
                    console.error('Failed to load cart:', e);
                    cart = [];
                }
            }

            function showNotification(message) {
                var notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 z-50 px-6 py-4 bg-green-500/20 border border-green-500/50 text-green-300 rounded-lg shadow-lg';
                notification.innerHTML = '<div class="flex items-center"><i class="fas fa-check-circle mr-3"></i><span>' + message + '</span></div>';
                document.body.appendChild(notification);

                setTimeout(function() {
                    notification.style.opacity = '0';
                    notification.style.transition = 'opacity 0.3s';
                    setTimeout(function() { notification.remove(); }, 300);
                }, 2000);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }
        })();
    </script>
</div>
</body>
</html>
