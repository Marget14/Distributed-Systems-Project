<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Store Details</title>
    <!-- CSRF Meta Tags for JavaScript -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div layout:fragment="main">
    <div id="storeData"
         th:data-store-id="${store.id()}"
         th:data-delivery-fee="${store.deliveryFee()}"
         th:data-min-order="${store.minimumOrderAmount()}">

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left: Store Info & Menu Items -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Store Header -->
                <div class="glass-panel p-6">
                    <h1 class="text-3xl font-bold text-white mb-2" th:text="${store.name()}">Store</h1>
                    <p class="text-gray-400 mb-3" th:text="${store.description()}">Description</p>
                    <div class="flex gap-4 text-sm text-gray-400">
                        <span><i class="fas fa-clock mr-1"></i><span th:text="${store.estimatedDeliveryTimeMinutes()}">30</span> min</span>
                        <span><i class="fas fa-coins mr-1"></i>Min ‚Ç¨<span th:text="${store.minimumOrderAmount()}">10</span></span>
                    </div>
                </div>

                <!-- Menu Items -->
                <div class="space-y-4">
                    <div th:each="item : ${menuItems}"
                         class="glass-panel p-4 menu-item">
                        <div class="flex justify-between">
                            <div>
                                <h3 class="text-lg font-bold text-white" th:text="${item.name()}">Item</h3>
                                <p class="text-sm text-gray-400" th:text="${item.description()}">Desc</p>
                                <span class="text-xl text-cyber-blue font-bold">‚Ç¨<span th:text="${item.price()}">0</span></span>
                            </div>
                            <div th:if="${item.available()}">
                                <input type="hidden" class="item-id" th:value="${item.id()}"/>
                                <input type="hidden" class="item-name" th:value="${item.name()}"/>
                                <input type="hidden" class="item-price" th:value="${item.price()}"/>
                                <button class="add-btn cyber-button h-fit">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Cart -->
            <div class="lg:col-span-1">
                <div class="glass-panel p-6 sticky top-24">
                    <h2 class="text-xl font-bold text-white mb-4"><i class="fas fa-shopping-cart mr-2"></i>Cart</h2>

                    <div id="emptyCart" class="text-center py-8">
                        <i class="fas fa-shopping-cart text-4xl text-gray-600 mb-2"></i>
                        <p class="text-gray-400">Empty</p>
                    </div>

                    <div id="cartItems" class="hidden space-y-3 mb-4"></div>

                    <div id="cartSummary" class="hidden border-t border-white/10 pt-4">
                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-gray-300">
                                <span>Subtotal</span>
                                <span id="subtotal">‚Ç¨0</span>
                            </div>
                            <div class="flex justify-between text-gray-300">
                                <span>Delivery</span>
                                <span id="deliveryDisplay">‚Ç¨0</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-white">
                                <span>Total</span>
                                <span id="total">‚Ç¨0</span>
                            </div>
                        </div>
                        <button id="checkoutBtn" class="w-full cyber-button py-3 relative">
                            <i class="fas fa-shopping-bag mr-2"></i>View Cart
                            <span id="cartBadge" class="absolute -top-2 -right-2 w-6 h-6 bg-neon-pink rounded-full flex items-center justify-center text-xs font-bold">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="none">
        (function() {
            console.log('üöÄ Cart sync script loaded');

            var cart = [];
            var config = {
                storeId: '',
                deliveryFee: 0,
                minOrder: 0,
                isUpdating: false
            };

            // ==================== CSRF UTILITIES ====================
            function getCsrfToken() {
                const metaTag = document.querySelector('meta[name="_csrf"]');
                if (metaTag && metaTag.content) {
                    console.log('üîë Found CSRF token in meta tag');
                    return metaTag.content;
                }

                const cookieMatch = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
                if (cookieMatch && cookieMatch[1]) {
                    console.log('üîë Found CSRF token in cookie');
                    return decodeURIComponent(cookieMatch[1]);
                }

                const inputToken = document.querySelector('input[name="_csrf"]');
                if (inputToken && inputToken.value) {
                    console.log('üîë Found CSRF token in hidden input');
                    return inputToken.value;
                }

                console.warn('‚ö†Ô∏è No CSRF token found! Requests may fail.');
                return '';
            }

            function getCsrfHeaderName() {
                const metaTag = document.querySelector('meta[name="_csrf_header"]');
                return (metaTag && metaTag.content) ? metaTag.content : 'X-CSRF-TOKEN';
            }

            function makeAuthenticatedRequest(url, options = {}) {
                const csrfToken = getCsrfToken();
                const csrfHeader = getCsrfHeaderName();

                const defaultHeaders = {
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest',
                    [csrfHeader]: csrfToken
                };

                const method = (options.method || 'GET').toUpperCase();
                if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
                    defaultHeaders['Content-Type'] = 'application/json';
                }

                return fetch(url, {
                    ...options,
                    headers: {
                        ...defaultHeaders,
                        ...options.headers
                    },
                    credentials: 'same-origin'
                });
            }

            // ==================== INITIALIZATION ====================
            function init() {
                console.log('üîÑ Initializing cart system');

                var el = document.getElementById('storeData');
                if (!el) {
                    console.error('‚ùå storeData element not found!');
                    return;
                }

                config.storeId = el.dataset.storeId;
                config.deliveryFee = parseFloat(el.dataset.deliveryFee);
                config.minOrder = parseFloat(el.dataset.minOrder);

                console.log('üìã Config loaded:', config);
                console.log('üÜî Session will be used via JSESSIONID cookie');

                loadCartFromServer();
                setupEventListeners();

                document.addEventListener('visibilitychange', function() {
                    if (!document.hidden) {
                        console.log('üëÄ Page became visible, refreshing cart');
                        loadCartFromServer();
                    }
                });
            }

            function setupEventListeners() {
                console.log('üîó Setting up event listeners');

                document.querySelectorAll('.add-btn').forEach(function(btn) {
                    var newBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(newBtn, btn);

                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();

                        console.log('‚ûï Add button clicked');
                        var container = this.closest('.menu-item');
                        if (!container) return;

                        var itemData = {
                            id: container.querySelector('.item-id').value,
                            name: container.querySelector('.item-name').value,
                            price: parseFloat(container.querySelector('.item-price').value),
                            quantity: 1
                        };

                        console.log('üì¶ Adding item:', itemData);
                        addItemToServerCart(itemData);
                    });
                });

                var checkoutBtn = document.getElementById('checkoutBtn');
                if (checkoutBtn) {
                    checkoutBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        console.log('üõí Navigating to cart page');
                        loadCartFromServer();
                        setTimeout(function() {
                            window.location.href = '/cart';
                        }, 300);
                    });
                }
            }

            // ==================== CART API FUNCTIONS ====================
            function loadCartFromServer() {
                if (config.isUpdating) {
                    console.log('‚è≥ Skipping load - already updating');
                    return;
                }

                console.log('üîÑ Loading cart from server session');

                makeAuthenticatedRequest('/api/cart/items')
                    .then(function(response) {
                        if (!response.ok) {
                            throw new Error('HTTP ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('‚úÖ Server cart response:', data);

                        cart = [];
                        var serverItems = data.items || [];

                        if (!Array.isArray(serverItems) && typeof serverItems === 'object') {
                            serverItems = Object.values(serverItems);
                        }

                        serverItems.forEach(function(item) {
                            cart.push({
                                id: item.id || item.menuItemId,
                                name: item.name,
                                price: item.price || item.priceAtTime,
                                quantity: item.quantity || 1,
                                storeId: item.storeId
                            });
                        });

                        console.log('üìä Local cart updated:', cart.length, 'items');
                        renderCartUI();
                    })
                    .catch(function(error) {
                        console.error('‚ùå Failed to load cart:', error);
                        cart = [];
                        renderCartUI();
                    });
            }

            function addItemToServerCart(item) {
                if (config.isUpdating) {
                    console.log('‚è≥ Already updating, skipping');
                    return;
                }

                config.isUpdating = true;
                var originalButton = event.target;
                var originalText = originalButton.innerHTML;
                originalButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                originalButton.disabled = true;

                console.log('üì§ Sending to server with CSRF protection:', item);

                makeAuthenticatedRequest('/api/cart/items', {
                    method: 'POST',
                    body: JSON.stringify({
                        menuItemId: parseInt(item.id),
                        quantity: item.quantity
                    })
                })
                    .then(function(response) {
                        if (!response.ok) {
                            return response.text().then(function(text) {
                                throw new Error(text || 'HTTP ' + response.status);
                            });
                        }
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('‚úÖ Server add response:', data);

                        showNotification('‚úÖ ' + item.name + ' added to cart!');

                        setTimeout(function() {
                            loadCartFromServer();
                        }, 300);

                        if (data.cartSize !== undefined) {
                            updateCartBadge(data.cartSize);
                        }
                    })
                    .catch(function(error) {
                        console.error('‚ùå Error adding to cart:', error);

                        if (error.message.includes('403')) {
                            showNotification('‚ùå Please refresh the page and try again', 'error');
                        } else {
                            showNotification('‚ùå Failed to add item: ' + error.message, 'error');
                        }
                    })
                    .finally(function() {
                        originalButton.innerHTML = originalText;
                        originalButton.disabled = false;
                        config.isUpdating = false;
                    });
            }

            function updateCartBadge(count) {
                var badge = document.getElementById('cartBadge');
                if (badge) {
                    badge.textContent = count;
                    badge.classList.add('pulse');
                    setTimeout(function() {
                        badge.classList.remove('pulse');
                    }, 500);
                }
            }

            function renderCartUI() {
                console.log('üé® Rendering cart UI with', cart.length, 'items');

                var emptyEl = document.getElementById('emptyCart');
                var itemsEl = document.getElementById('cartItems');
                var summaryEl = document.getElementById('cartSummary');

                if (!emptyEl || !itemsEl || !summaryEl) {
                    console.error('‚ùå Cart UI elements not found!');
                    return;
                }

                if (cart.length === 0) {
                    emptyEl.classList.remove('hidden');
                    itemsEl.classList.add('hidden');
                    summaryEl.classList.add('hidden');
                    updateCartBadge(0);
                    return;
                }

                emptyEl.classList.add('hidden');
                itemsEl.classList.remove('hidden');
                summaryEl.classList.remove('hidden');

                itemsEl.innerHTML = '';

                var subtotal = 0;
                var totalItems = 0;

                cart.forEach(function(item) {
                    subtotal += item.price * item.quantity;
                    totalItems += item.quantity;

                    var itemEl = document.createElement('div');
                    itemEl.className = 'bg-white/5 rounded-lg p-4 mb-3';
                    itemEl.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="font-semibold text-white">${item.name}</h4>
                            <p class="text-sm text-gray-400">‚Ç¨${item.price.toFixed(2)} each</p>
                        </div>
                        <button onclick="removeItemFromServer('${item.id}')"
                                class="text-red-400 hover:text-red-300 ml-2">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <button onclick="updateQuantityOnServer('${item.id}', -1)"
                                    class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <span class="w-8 text-center font-bold">${item.quantity}</span>
                            <button onclick="updateQuantityOnServer('${item.id}', 1)"
                                    class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                        </div>
                        <span class="font-bold text-cyber-blue">
                            ‚Ç¨${(item.price * item.quantity).toFixed(2)}
                        </span>
                    </div>
                `;

                    itemsEl.appendChild(itemEl);
                });

                var delivery = config.deliveryFee || 0;
                var total = subtotal + delivery;

                document.getElementById('subtotal').textContent = '‚Ç¨' + subtotal.toFixed(2);
                document.getElementById('deliveryDisplay').textContent = '‚Ç¨' + delivery.toFixed(2);
                document.getElementById('total').textContent = '‚Ç¨' + total.toFixed(2);

                updateCartBadge(totalItems);
            }

            // ==================== GLOBAL FUNCTIONS ====================
            window.removeItemFromServer = function(itemId) {
                console.log('üóëÔ∏è Removing item:', itemId);

                makeAuthenticatedRequest('/api/cart/items/' + itemId, {
                    method: 'DELETE'
                })
                    .then(function(response) {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        showNotification('Item removed from cart');
                        setTimeout(loadCartFromServer, 300);
                    })
                    .catch(function(error) {
                        console.error('‚ùå Error removing item:', error);
                        showNotification('‚ùå Failed to remove item', 'error');
                    });
            };

            window.updateQuantityOnServer = function(itemId, change) {
                console.log('üîÑ Updating quantity for', itemId, 'change:', change);

                makeAuthenticatedRequest('/api/cart/items/' + itemId + '/quantity', {
                    method: 'PUT',
                    body: JSON.stringify({ change: change })
                })
                    .then(function(response) {
                        if (!response.ok) throw new Error('HTTP ' + response.status);
                        return response.json();
                    })
                    .then(function(data) {
                        console.log('‚úÖ Quantity update response:', data);
                        showNotification('Quantity updated');
                        setTimeout(loadCartFromServer, 300);
                    })
                    .catch(function(error) {
                        console.error('‚ùå Error updating quantity:', error);
                        showNotification('‚ùå Failed to update quantity', 'error');
                    });
            };

            function showNotification(message, type) {
                var icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
                var bgColor = type === 'error' ? 'bg-red-500/20 border-red-500/50' : 'bg-green-500/20 border-green-500/50';
                var textColor = type === 'error' ? 'text-red-300' : 'text-green-300';

                var notification = document.createElement('div');
                notification.className = `fixed top-6 right-6 z-50 px-6 py-4 ${bgColor} border ${textColor} rounded-lg shadow-xl transform transition-all duration-300 translate-x-full`;
                notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas ${icon} mr-3"></i>
                    <span class="font-medium">${message}</span>
                </div>
            `;

                document.body.appendChild(notification);

                setTimeout(function() {
                    notification.classList.remove('translate-x-full');
                }, 10);

                setTimeout(function() {
                    notification.classList.add('translate-x-full');
                    setTimeout(function() {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // ==================== STARTUP ====================
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', init);
            } else {
                init();
            }

            // ==================== DEBUG HELPER ====================
            window.debugCsrf = function() {
                console.group('üîê CSRF Debug Info');
                console.log('Token:', getCsrfToken());
                console.log('Header Name:', getCsrfHeaderName());
                console.log('Meta Tag exists:', !!document.querySelector('meta[name="_csrf"]'));
                console.log('Cookies:', document.cookie);
                console.groupEnd();
            };

            // CSS Œ≥ŒπŒ± animations
            var style = document.createElement('style');
            style.textContent = `
            .pulse {
                animation: pulse 0.5s ease-in-out;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
        `;
            document.head.appendChild(style);

        })();
    </script>
</div>
</body>
</html>