<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚ - StreetFoodGo</title>
</head>
<body>
<main layout:fragment="main">
    <style>
        .payment-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .payment-card:hover {
            border-color: #0d6efd;
            background-color: #f8f9fa;
        }
        .payment-card.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
        .card-form {
            display: none;
            margin-top: 20px;
        }
        .card-form.active {
            display: block;
        }
        .address-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        .address-card:hover {
            border-color: #0d6efd;
        }
        .address-card.selected {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }
    </style>
    <div class="container mt-4">
        <h2>ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</h2>

        <div th:if="${errorMessage}" class="alert alert-danger" role="alert" th:text="${errorMessage}"></div>

        <div class="row">
            <!-- Left Column: Order Summary -->
            <div class="col-md-7">
                <form method="post" action="/checkout/process" id="checkoutForm">
                    
                    <!-- Step 1: Order Type -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">1. Î¤ÏÏŒÏ€Î¿Ï‚ Î Î±ÏÎ±Î»Î±Î²Î®Ï‚</h5>
                        </div>
                        <div class="card-body">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="orderType" id="orderTypeDelivery" 
                                       value="DELIVERY" required>
                                <label class="form-check-label" for="orderTypeDelivery">
                                    <strong>Delivery</strong> - Î Î±ÏÎ¬Î´Î¿ÏƒÎ· ÏƒÏ„Î· Î´Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ® ÏƒÎ±Ï‚
                                    <span th:if="${deliveryFee != null and deliveryFee > 0}">
                                        (ÎšÏŒÏƒÏ„Î¿Ï‚: â‚¬<span th:text="${#numbers.formatDecimal(deliveryFee, 1, 2)}"></span>)
                                    </span>
                                </label>
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="radio" name="orderType" id="orderTypePickup" 
                                       value="PICKUP" required checked>
                                <label class="form-check-label" for="orderTypePickup">
                                    <strong>Î Î±ÏÎ±Î»Î±Î²Î®</strong> - Î Î±ÏÎ±Î»Î±Î²Î® Î±Ï€ÏŒ Ï„Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Delivery Address (shown only for DELIVERY) -->
                    <div class="card mb-3" id="deliveryAddressSection" style="display: none;">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">2. Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ· Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚</h5>
                        </div>
                        <div class="card-body">
                            <div th:if="${addresses.empty}">
                                <p class="text-muted">Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î±Ï€Î¿Î¸Î·ÎºÎµÏ…Î¼Î­Î½ÎµÏ‚ Î´Î¹ÎµÏ…Î¸ÏÎ½ÏƒÎµÎ¹Ï‚.</p>
                                <a href="/addresses/new" class="btn btn-primary">Î ÏÎ¿ÏƒÎ¸Î®ÎºÎ· Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·Ï‚</a>
                            </div>
                            <div th:unless="${addresses.empty}">
                                <div th:each="address : ${addresses}" class="address-card" 
                                     th:data-address-id="${address.id}">
                                    <input type="radio" name="deliveryAddressId" th:value="${address.id}" 
                                           th:id="'address-' + ${address.id}" style="display: none;">
                                    <strong th:text="${address.label}"></strong><br>
                                    <span th:text="${address.streetAddress}"></span>,
                                    <span th:text="${address.city}"></span>
                                    <span th:text="${address.postalCode}"></span>
                                </div>
                                <a href="/addresses/new" class="btn btn-sm btn-outline-primary mt-2">+ ÎÎ­Î± Î”Î¹ÎµÏÎ¸Ï…Î½ÏƒÎ·</a>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Payment Method -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">3. Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</h5>
                        </div>
                        <div class="card-body">
                            <!-- Cash Payment -->
                            <div class="payment-card" data-payment="CASH">
                                <input type="radio" name="paymentMethod" id="paymentCash" value="CASH" required checked>
                                <label for="paymentCash" style="cursor: pointer; width: 100%;">
                                    <h5>ğŸ’µ ÎœÎµÏ„ÏÎ·Ï„Î¬</h5>
                                    <p class="mb-0 text-muted">Î Î»Î·ÏÏ‰Î¼Î® Î¼Îµ Î¼ÎµÏ„ÏÎ·Ï„Î¬ ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· (Î‘Î½Ï„Î¹ÎºÎ±Ï„Î±Î²Î¿Î»Î®)</p>
                                </label>
                            </div>

                            <!-- Card Payment -->
                            <div class="payment-card" data-payment="CARD">
                                <input type="radio" name="paymentMethod" id="paymentCard" value="CARD">
                                <label for="paymentCard" style="cursor: pointer; width: 100%;">
                                    <h5>ğŸ’³ Î Î¹ÏƒÏ„Ï‰Ï„Î¹ÎºÎ®/Î§ÏÎµÏ‰ÏƒÏ„Î¹ÎºÎ® ÎšÎ¬ÏÏ„Î±</h5>
                                    <p class="mb-0 text-muted">Î‘ÏƒÏ†Î±Î»Î®Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î® Î¼Îµ ÎºÎ¬ÏÏ„Î±</p>
                                </label>
                                
                                <!-- Card Form (hidden by default) -->
                                <div class="card-form" id="cardForm">
                                    <hr>
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label for="cardNumber" class="form-label">Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚ ÎšÎ¬ÏÏ„Î±Ï‚</label>
                                            <input type="text" class="form-control" id="cardNumber" name="cardNumber" 
                                                   placeholder="1234 5678 9012 3456" maxlength="19">
                                        </div>
                                        <div class="col-md-12 mb-3">
                                            <label for="cardHolderName" class="form-label">ÎŒÎ½Î¿Î¼Î± ÎšÎ±Ï„ÏŒÏ‡Î¿Ï…</label>
                                            <input type="text" class="form-control" id="cardHolderName" name="cardHolderName" 
                                                   placeholder="ÎŸÎÎŸÎœÎ‘ Î•Î Î©ÎÎ¥ÎœÎŸ">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">Î›Î®Î¾Î·</label>
                                            <div class="row">
                                                <div class="col-6">
                                                    <select class="form-select" id="expiryMonth" name="expiryMonth">
                                                        <option value="">ÎœÎ®Î½Î±Ï‚</option>
                                                        <option th:each="i : ${#numbers.sequence(1, 12)}" 
                                                                th:value="${i}" th:text="${#numbers.formatInteger(i, 2)}"></option>
                                                    </select>
                                                </div>
                                                <div class="col-6">
                                                    <select class="form-select" id="expiryYear" name="expiryYear">
                                                        <option value="">ÎˆÏ„Î¿Ï‚</option>
                                                        <option th:each="i : ${#numbers.sequence(2024, 2034)}" 
                                                                th:value="${i}" th:text="${i}"></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="cvv" class="form-label">CVV</label>
                                            <input type="text" class="form-control" id="cvv" name="cvv" 
                                                   placeholder="123" maxlength="3">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Notes -->
                    <div class="card mb-3">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">4. Î£Ï‡ÏŒÎ»Î¹Î± (Î ÏÎ¿Î±Î¹ÏÎµÏ„Î¹ÎºÎ¬)</h5>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" name="customerNotes" rows="3" 
                                      placeholder="Ï€.Ï‡. Î Î±ÏÎ±ÎºÎ±Î»Ï Î½Î± Î¼Î·Î½ Î²Î¬Î»ÎµÏ„Îµ ÎºÏÎµÎ¼Î¼ÏÎ´Î¹Î±..."></textarea>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-lg w-100">
                        ÎŸÎ»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚ - â‚¬<span id="finalTotal" th:text="${#numbers.formatDecimal(total, 1, 2)}"></span>
                    </button>
                </form>
            </div>

            <!-- Right Column: Cart Summary -->
            <div class="col-md-5">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Î ÎµÏÎ¯Î»Î·ÏˆÎ· Î Î±ÏÎ±Î³Î³ÎµÎ»Î¯Î±Ï‚</h5>
                    </div>
                    <div class="card-body">
                        <h6 th:text="${store.name}"></h6>
                        <hr>
                        
                        <div th:each="item : ${cartDetails}" class="mb-2">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong th:text="${item.cartLine.quantity} + 'x ' + ${item.menuItem.name}"></strong>
                                </div>
                                <div>
                                    â‚¬<span th:text="${#numbers.formatDecimal(item.cartLine.totalPrice, 1, 2)}"></span>
                                </div>
                            </div>
                        </div>
                        
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span>Î¥Ï€Î¿ÏƒÏÎ½Î¿Î»Î¿:</span>
                            <span>â‚¬<span th:text="${#numbers.formatDecimal(subtotal, 1, 2)}"></span></span>
                        </div>
                        <div class="d-flex justify-content-between" id="deliveryFeeRow" style="display: none;">
                            <span>ÎšÏŒÏƒÏ„Î¿Ï‚ Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚:</span>
                            <span>â‚¬<span id="deliveryFeeAmount" th:text="${#numbers.formatDecimal(deliveryFee, 1, 2)}"></span></span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <strong>Î£ÏÎ½Î¿Î»Î¿:</strong>
                            <strong>â‚¬<span id="totalAmount" th:text="${#numbers.formatDecimal(total, 1, 2)}"></span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const subtotal = /*[[${subtotal}]]*/ 0;
        const deliveryFee = /*[[${deliveryFee}]]*/ 0;

        // Handle order type change
        document.querySelectorAll('input[name="orderType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const deliverySection = document.getElementById('deliveryAddressSection');
                const deliveryFeeRow = document.getElementById('deliveryFeeRow');
                
                if (this.value === 'DELIVERY') {
                    deliverySection.style.display = 'block';
                    deliveryFeeRow.style.display = 'flex';
                    updateTotal(subtotal + deliveryFee);
                } else {
                    deliverySection.style.display = 'none';
                    deliveryFeeRow.style.display = 'none';
                    updateTotal(subtotal);
                }
            });
        });

        // Handle payment method selection
        document.querySelectorAll('.payment-card').forEach(card => {
            card.addEventListener('click', function() {
                const payment = this.getAttribute('data-payment');
                const radio = document.getElementById('payment' + payment.charAt(0) + payment.slice(1).toLowerCase());
                radio.checked = true;
                
                // Remove selected class from all cards
                document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
                
                // Show/hide card form
                const cardForm = document.getElementById('cardForm');
                if (payment === 'CARD') {
                    cardForm.classList.add('active');
                    // Make card fields required
                    document.getElementById('cardNumber').required = true;
                    document.getElementById('cardHolderName').required = true;
                    document.getElementById('expiryMonth').required = true;
                    document.getElementById('expiryYear').required = true;
                    document.getElementById('cvv').required = true;
                } else {
                    cardForm.classList.remove('active');
                    // Make card fields not required
                    document.getElementById('cardNumber').required = false;
                    document.getElementById('cardHolderName').required = false;
                    document.getElementById('expiryMonth').required = false;
                    document.getElementById('expiryYear').required = false;
                    document.getElementById('cvv').required = false;
                }
            });
        });

        // Handle address selection
        document.querySelectorAll('.address-card').forEach(card => {
            card.addEventListener('click', function() {
                const addressId = this.getAttribute('data-address-id');
                const radio = document.getElementById('address-' + addressId);
                radio.checked = true;
                
                // Remove selected class from all cards
                document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
                this.classList.add('selected');
            });
        });

        // Update total display
        function updateTotal(total) {
            document.getElementById('totalAmount').textContent = total.toFixed(2);
            document.getElementById('finalTotal').textContent = total.toFixed(2);
        }

        // Initialize: select first payment method
        document.querySelector('.payment-card[data-payment="CASH"]').classList.add('selected');
        /*]]>*/
    </script>
</main>
</body>
</html>
