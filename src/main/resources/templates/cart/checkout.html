<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Checkout</title>
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div layout:fragment="main">
    <!-- Checkout Header -->
    <div class="glass-panel p-8 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-orbitron font-bold text-white mb-2">Checkout</h1>
                <p class="text-gray-400">Confirm your order details</p>
            </div>
        </div>
    </div>

    <!-- Error Message if any -->
    <div th:if="${error}" class="glass-panel p-12 text-center bg-red-500/20 border border-red-500/50">
        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
        <h3 class="text-xl font-bold text-white mb-2">Error</h3>
        <p class="text-red-300 mb-6" th:text="${error}"></p>
        <a th:href="@{/cart}" class="cyber-button inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Back to Cart
        </a>
    </div>

    <!-- Checkout Content -->
    <div th:if="${cart != null && cart.storeGroups != null && !cart.storeGroups.empty}"
         class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left: Order Items -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Store Grouping -->
            <div th:each="storeGroup : ${cart.storeGroups}"
                 class="glass-panel p-6 store-group"
                 th:data-store-id="${storeGroup.storeId}">

                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyber-blue/20 to-quantum/20
                                flex items-center justify-center mr-3">
                        <i class="fas fa-store text-cyber-blue"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white" th:text="${storeGroup.storeName}">Store</h3>
                        <p class="text-gray-400 text-sm" th:text="${storeGroup.storeArea}">Area</p>
                    </div>
                </div>

                <!-- Items -->
                <div th:each="item, iterStat : ${storeGroup.items}"
                     th:class="${!iterStat.last ? 'border-b border-white/10 pb-6 mb-6' : 'pb-2'}">

                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-grow">
                            <h4 class="font-bold text-white" th:text="${item.name}">Item</h4>
                            <p class="text-gray-400 text-sm" th:text="${item.description}">Description</p>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <!-- Quantity (Read-only in checkout) -->
                        <div class="flex items-center gap-3">
                            <span class="text-gray-400 text-sm">Qty:</span>
                            <span class="text-white font-bold" th:text="${item.quantity}">1</span>
                        </div>

                        <!-- Price -->
                        <div class="text-right">
                            <p class="text-xl font-bold text-cyber-blue">
                                ‚Ç¨<span th:text="${#numbers.formatDecimal(item.totalPrice, 1, 2)}">0.00</span>
                            </p>
                            <p class="text-gray-400 text-sm">
                                ‚Ç¨<span th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)}">0.00</span> each
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Special Instructions -->
            <div class="glass-panel p-6">
                <h4 class="text-white mb-3">Special Instructions</h4>
                <textarea id="specialInstructions"
                          class="quantum-input w-full h-24"
                          placeholder="Any special requests for your order?"
                          th:text="${specialInstructions}"></textarea>
            </div>
        </div>

        <!-- Right: Order Summary and Address -->
        <div class="lg:col-span-1">
            <div class="glass-panel p-6 sticky top-24 space-y-6">
                <h3 class="text-xl font-bold text-white mb-4">Order Summary</h3>

                <!-- Order Type (Read-only) -->
                <div>
                    <h4 class="text-white mb-2 text-sm font-semibold">Order Type</h4>
                    <div class="flex items-center gap-2">
                        <i th:if="${orderType == 'DELIVERY'}" class="fas fa-truck text-cyber-blue"></i>
                        <i th:if="${orderType == 'PICKUP'}" class="fas fa-walking text-cyber-blue"></i>
                        <span class="text-cyber-blue font-semibold" th:text="${orderType}">Delivery</span>
                    </div>
                </div>

                <!-- Payment Method Section (ADD THIS) -->
                <div class="mb-4">
                    <h4 class="text-white mb-3 text-sm font-semibold">Payment Method *</h4>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 border border-white/10 rounded-lg hover:border-cyber-blue/50 cursor-pointer">
                            <input type="radio" name="paymentMethod" value="CASH" class="mr-3" checked
                                   onchange="setPaymentMethod('CASH')">
                            <div>
                                <p class="text-white font-medium">Cash on Delivery</p>
                                <p class="text-gray-400 text-xs">Pay with cash when you receive your order</p>
                            </div>
                            <i class="fas fa-money-bill-wave ml-auto text-green-400"></i>
                        </label>

                        <label class="flex items-center p-3 border border-white/10 rounded-lg hover:border-cyber-blue/50 cursor-pointer">
                            <input type="radio" name="paymentMethod" value="CARD" class="mr-3"
                                   onchange="setPaymentMethod('CARD')">
                            <div>
                                <p class="text-white font-medium">Credit/Debit Card</p>
                                <p class="text-gray-400 text-xs">Pay securely with your card</p>
                            </div>
                            <i class="fas fa-credit-card ml-auto text-blue-400"></i>
                        </label>
                    </div>
                    <div id="cardDetailsSection" class="mt-3 hidden">
                        <div class="space-y-3">
                            <input type="text" placeholder="Card Number"
                                   class="quantum-input w-full text-sm" maxlength="19">
                            <div class="grid grid-cols-2 gap-3">
                                <input type="text" placeholder="MM/YY"
                                       class="quantum-input text-sm">
                                <input type="text" placeholder="CVV"
                                       class="quantum-input text-sm" maxlength="3">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Delivery Address Section (Visible only for DELIVERY) -->
                <div id="deliveryAddressSection" th:if="${orderType == 'DELIVERY'}">
                    <h4 class="text-white mb-3 text-sm font-semibold">Delivery Address</h4>

                    <!-- No Address Warning -->
                    <div id="noAddressWarning" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg">
                        <p class="text-red-300 text-sm">‚ö†Ô∏è Please select or add a delivery address</p>
                    </div>

                    <!-- Saved Addresses -->
                    <div th:if="${userAddresses != null && !userAddresses.empty}" class="mb-4">
                        <select id="savedAddressSelect"
                                class="quantum-input w-full text-sm"
                                onchange="onAddressSelect(this.value)">
                            <option value="">-- Select Address --</option>
                            <option th:each="addr : ${userAddresses}"
                                    th:value="${addr.id}"
                                    th:text="${addr.label + ' - ' + addr.street}">
                            </option>
                            <option value="new">+ Add New Address</option>
                        </select>
                    </div>

                    <!-- If no addresses, show add new button -->
                    <div th:if="${userAddresses == null || userAddresses.empty}" class="mb-4">
                        <button type="button" onclick="showNewAddressForm()"
                                class="w-full cyber-button-secondary py-2 text-sm">
                            <i class="fas fa-plus mr-2"></i>Add Delivery Address
                        </button>
                    </div>

                    <!-- New Address Form -->
                    <div id="newAddressForm" class="space-y-3 hidden">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Address Label *</label>
                            <input type="text" id="addressLabel"
                                   class="quantum-input w-full text-sm"
                                   placeholder="Home, Work, etc.">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Street Address *</label>
                            <input type="text" id="streetAddress"
                                   class="quantum-input w-full text-sm"
                                   placeholder="123 Main Street">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">City *</label>
                            <input type="text" id="city"
                                   class="quantum-input w-full text-sm"
                                   placeholder="Athens">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Postal Code *</label>
                            <input type="text" id="postalCode"
                                   class="quantum-input w-full text-sm"
                                   placeholder="10431">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Phone Number</label>
                            <input type="text" id="phoneNumber"
                                   class="quantum-input w-full text-sm"
                                   placeholder="+30 123 456 7890">
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="saveNewAddress()"
                                    class="flex-1 cyber-button-secondary py-2 text-sm">
                                <i class="fas fa-save mr-1"></i>Save
                            </button>
                            <button type="button" onclick="cancelNewAddress()"
                                    class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 text-sm rounded-lg">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Current Address Display -->
                    <div id="currentAddressDisplay" class="p-3 bg-white/5 rounded-lg hidden">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-white font-medium text-sm" id="displayLabel"></p>
                            <button type="button" onclick="changeAddress()"
                                    class="text-cyber-blue hover:text-cyber-blue-light text-xs">
                                Change
                            </button>
                        </div>
                        <p class="text-gray-400 text-xs" id="displayStreet"></p>
                        <p class="text-gray-400 text-xs" id="displayCityPostal"></p>
                        <p class="text-gray-400 text-xs" id="displayPhone"></p>
                        <input type="hidden" id="selectedAddressId">
                    </div>
                </div>

                <!-- Summary Details -->
                <div class="space-y-2 pt-4 border-t border-white/10">
                    <div class="flex justify-between text-gray-300 text-sm">
                        <span>Subtotal</span>
                        <span>‚Ç¨<span th:text="${#numbers.formatDecimal(cart.subtotal, 1, 2)}">0.00</span></span>
                    </div>
                    <div class="flex justify-between text-gray-300 text-sm">
                        <span>Delivery Fee</span>
                        <span>‚Ç¨<span th:text="${#numbers.formatDecimal(cart.deliveryTotal, 1, 2)}">0.00</span></span>
                    </div>
                    <div class="flex justify-between text-white font-bold text-lg pt-2 border-t border-white/10">
                        <span>Total</span>
                        <span>‚Ç¨<span th:text="${#numbers.formatDecimal(cart.total, 1, 2)}">0.00</span></span>
                    </div>
                </div>

                <!-- Place Order Button -->
                <button type="button" id="placeOrderButton" onclick="validateAndPlaceOrder()"
                        class="w-full cyber-button py-3">
                    <i class="fas fa-check-circle mr-2"></i>Place Order
                </button>

                <!-- Back to Cart -->
                <a th:href="@{/cart}" class="block text-center text-gray-400 hover:text-white text-sm">
                    <i class="fas fa-arrow-left mr-1"></i>Back to Cart
                </a>
            </div>
        </div>
    </div>
</div>

<script th:inline="none">
    // ==================== CSRF UTILITIES ====================
    function getCsrfToken() {
        const metaTag = document.querySelector('meta[name="_csrf"]');
        if (metaTag && metaTag.content) return metaTag.content;

        const cookieMatch = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
        if (cookieMatch && cookieMatch[1]) return decodeURIComponent(cookieMatch[1]);

        return '';
    }

    function getCsrfHeaderName() {
        const metaTag = document.querySelector('meta[name="_csrf_header"]');
        return (metaTag && metaTag.content) ? metaTag.content : 'X-CSRF-TOKEN';
    }

    function makeAuthenticatedRequest(url, options = {}) {
        const csrfToken = getCsrfToken();
        const csrfHeader = getCsrfHeaderName();

        const defaultHeaders = {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            [csrfHeader]: csrfToken
        };

        const method = (options.method || 'GET').toUpperCase();
        if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
            defaultHeaders['Content-Type'] = 'application/json';
        }

        return fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            },
            credentials: 'same-origin'
        });
    }

    // ==================== GLOBAL STATE ====================
    let selectedAddressId = null;
    let orderType = 'DELIVERY';
    let selectedPaymentMethod = 'CASH'; // Default

    // ==================== PAYMENT METHOD ====================
    function setPaymentMethod(method) {
        console.log('üí≥ Setting payment method:', method);
        selectedPaymentMethod = method;

        // Show/hide card details
        const cardSection = document.getElementById('cardDetailsSection');
        if (method === 'CARD') {
            cardSection.classList.remove('hidden');
        } else {
            cardSection.classList.add('hidden');
        }

        updatePlaceOrderButton();
    }

    // ==================== ADDRESS FUNCTIONS ====================
    function showNewAddressForm() {
        document.getElementById('newAddressForm').classList.remove('hidden');
        const select = document.getElementById('savedAddressSelect');
        if (select) select.classList.add('hidden');
    }

    function onAddressSelect(value) {
        console.log('üìç Address selected:', value);

        if (value === 'new') {
            showNewAddressForm();
            return;
        } else if (value === '') {
            selectedAddressId = null;
            document.getElementById('currentAddressDisplay').classList.add('hidden');
            document.getElementById('noAddressWarning').classList.remove('hidden');
            updatePlaceOrderButton();
            return;
        }

        // For now, just set the ID (assuming addresses are already loaded)
        // In a real app, you'd fetch from /api/addresses/{id}
        selectedAddressId = value;

        // Show selected address display
        document.getElementById('savedAddressSelect').classList.add('hidden');
        document.getElementById('currentAddressDisplay').classList.remove('hidden');
        document.getElementById('noAddressWarning').classList.add('hidden');

        // Get the selected option text
        const select = document.getElementById('savedAddressSelect');
        const selectedOption = select.options[select.selectedIndex];
        const addressText = selectedOption.text;

        document.getElementById('displayLabel').textContent = addressText.split(' - ')[0];
        document.getElementById('displayStreet').textContent = addressText.split(' - ')[1] || '';
        document.getElementById('displayCityPostal').textContent = '';
        document.getElementById('displayPhone').textContent = '';

        updatePlaceOrderButton();
    }

    function cancelNewAddress() {
        console.log('‚ùå Cancelled new address');
        document.getElementById('newAddressForm').classList.add('hidden');
        const select = document.getElementById('savedAddressSelect');
        if (select) {
            select.classList.remove('hidden');
        }

        // Clear form fields
        document.getElementById('addressLabel').value = '';
        document.getElementById('streetAddress').value = '';
        document.getElementById('city').value = '';
        document.getElementById('postalCode').value = '';
        document.getElementById('phoneNumber').value = '';
    }

    function saveNewAddress() {
        console.log('üíæ Saving new address');

        const label = document.getElementById('addressLabel').value.trim();
        const street = document.getElementById('streetAddress').value.trim();
        const city = document.getElementById('city').value.trim();
        const postalCode = document.getElementById('postalCode').value.trim();
        const phone = document.getElementById('phoneNumber').value.trim();

        if (!label || !street || !city || !postalCode) {
            showNotification('Please fill all required fields', 'error');
            return;
        }

        const newAddress = {
            label: label,
            street: street,
            city: city,
            postalCode: postalCode,
            phoneNumber: phone
        };

        makeAuthenticatedRequest('/api/addresses', {
            method: 'POST',
            body: JSON.stringify(newAddress)
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to save address');
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Address saved:', data);
                selectedAddressId = data.id;

                document.getElementById('displayLabel').textContent = data.label;
                document.getElementById('displayStreet').textContent = data.street;
                document.getElementById('displayCityPostal').textContent = data.city + ', ' + data.postalCode;
                document.getElementById('displayPhone').textContent = data.phoneNumber || '';

                document.getElementById('currentAddressDisplay').classList.remove('hidden');
                document.getElementById('newAddressForm').classList.add('hidden');
                document.getElementById('noAddressWarning').classList.add('hidden');

                const select = document.getElementById('savedAddressSelect');
                if (select) {
                    select.classList.remove('hidden');
                    const option = document.createElement('option');
                    option.value = data.id;
                    option.textContent = data.label + ' - ' + data.street;
                    select.insertBefore(option, select.lastElementChild);
                    select.value = data.id;
                }

                showNotification('‚úÖ Address saved successfully');
                updatePlaceOrderButton();
            })
            .catch(error => {
                console.error('‚ùå Failed to save address:', error);
                showNotification('‚ùå Failed to save address: ' + error.message, 'error');
            });
    }

    function changeAddress() {
        console.log('üîÑ Change address clicked');
        document.getElementById('currentAddressDisplay').classList.add('hidden');
        const select = document.getElementById('savedAddressSelect');
        if (select) {
            select.classList.remove('hidden');
            select.value = '';
        }
        selectedAddressId = null;
        updatePlaceOrderButton();
    }

    // ==================== VALIDATION ====================
    function isOrderValid() {
        if (orderType === 'DELIVERY' && !selectedAddressId) {
            return false;
        }
        if (!selectedPaymentMethod) {
            return false;
        }
        return true;
    }

    function updatePlaceOrderButton() {
        const button = document.getElementById('placeOrderButton');
        if (isOrderValid()) {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function validateAndPlaceOrder() {
        console.log('üîç Validating order...');

        if (!isOrderValid()) {
            if (orderType === 'DELIVERY') {
                document.getElementById('noAddressWarning').classList.remove('hidden');
                showNotification('‚ö†Ô∏è Please select or add a delivery address', 'error');
            }
            return;
        }

        placeOrder();
    }

    // ==================== CHECKOUT ====================
    function placeOrder() {
        console.log('üí≥ Placing order...');

        const button = document.getElementById('placeOrderButton');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        button.disabled = true;

        const instructions = document.getElementById('specialInstructions').value;
        const checkoutData = {
            deliveryAddressId: orderType === 'DELIVERY' ? selectedAddressId : null,
            orderType: orderType,
            specialInstructions: instructions
        };

        console.log('üì§ Checkout data:', checkoutData);

        makeAuthenticatedRequest('/api/cart/checkout', {
            method: 'POST',
            body: JSON.stringify(checkoutData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.error || 'HTTP ' + response.status);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('‚úÖ Checkout successful:', data);

                if (data.orderIds && data.orderIds.length > 0) {
                    showNotification('‚úÖ ' + data.message);

                    setTimeout(() => {
                        if (data.orderIds.length === 1) {
                            window.location.href = '/orders/' + data.orderIds[0] + '/confirm';
                        } else {
                            window.location.href = '/orders/confirmation?ids=' + data.orderIds.join(',');
                        }
                    }, 1000);
                } else {
                    throw new Error('No order IDs returned');
                }
            })
            .catch(error => {
                console.error('‚ùå Checkout failed:', error);
                showNotification('‚ùå Checkout failed: ' + error.message, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    // ==================== NOTIFICATIONS ====================
    function showNotification(message, type = 'success') {
        const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
        const bgColor = type === 'error' ? 'bg-red-500/20 border-red-500/50' : 'bg-green-500/20 border-green-500/50';
        const textColor = type === 'error' ? 'text-red-300' : 'text-green-300';

        const notification = document.createElement('div');
        notification.className = `fixed top-6 right-6 z-50 px-6 py-4 ${bgColor} border ${textColor} rounded-lg shadow-xl transform transition-all duration-300 translate-x-full`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icon} mr-3"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;

        document.body.appendChild(notification);
        setTimeout(() => notification.classList.remove('translate-x-full'), 10);

        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üõí Checkout page loaded');
        console.log('üîê CSRF Token:', getCsrfToken() ? '‚úì Loaded' : '‚úó Not found');

        // Get order type from Thymeleaf
        const orderTypeElement = document.querySelector('[th\\:text="${orderType}"]');
        if (orderTypeElement) {
            orderType = orderTypeElement.textContent.trim();
            console.log('üì¶ Order type:', orderType);
        }

        updatePlaceOrderButton();
    });
</script>
</body>
</html>
