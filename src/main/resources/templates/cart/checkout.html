<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Checkout</title>
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div layout:fragment="main">
    <!-- Checkout Header -->
    <div class="glass-panel p-8 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-orbitron font-bold text-white mb-2">Checkout</h1>
                <p class="text-gray-400">Confirm your order details</p>
            </div>
        </div>
    </div>

    <!-- Error Message if any -->
    <div th:if="${error}" class="glass-panel p-12 text-center bg-red-500/20 border border-red-500/50">
        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
        <h3 class="text-xl font-bold text-white mb-2">Error</h3>
        <p class="text-red-300 mb-6" th:text="${error}"></p>
        <a th:href="@{/cart}" class="cyber-button inline-block">
            <i class="fas fa-arrow-left mr-2"></i>Back to Cart
        </a>
    </div>

    <!-- Checkout Content -->
    <div th:if="${cart != null && cart.storeGroups != null && !cart.storeGroups.empty}"
         class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left: Order Items -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Store Grouping -->
            <div th:each="storeGroup : ${cart.storeGroups}"
                 class="glass-panel p-6 store-group"
                 th:data-store-id="${storeGroup.storeId}">

                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyber-blue/20 to-quantum/20
                                flex items-center justify-center mr-3">
                        <i class="fas fa-store text-cyber-blue"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white" th:text="${storeGroup.storeName}">Store</h3>
                        <p class="text-gray-400 text-sm" th:text="${storeGroup.storeArea}">Area</p>
                    </div>
                </div>

                <!-- Items -->
                <div th:each="item, iterStat : ${storeGroup.items}"
                     th:class="${!iterStat.last ? 'border-b border-white/10 pb-6 mb-6' : 'pb-2'}">

                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-grow">
                            <h4 class="font-bold text-white" th:text="${item.name}">Item</h4>
                            <p class="text-gray-400 text-sm" th:text="${item.description}">Description</p>
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <!-- Quantity (Read-only in checkout) -->
                        <div class="flex items-center gap-3">
                            <span class="text-white font-bold min-w-[2rem] text-center"
                                  th:text="${item.quantity}">1</span>
                        </div>

                        <!-- Price -->
                        <div class="text-right">
                            <p class="text-xl font-bold text-cyber-blue">
                                €<span th:text="${#numbers.formatDecimal(item.totalPrice, 1, 2)}">0.00</span>
                            </p>
                            <p class="text-gray-400 text-sm">
                                €<span th:text="${#numbers.formatDecimal(item.unitPrice, 1, 2)}">0.00</span> each
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Special Instructions -->
            <div class="glass-panel p-6">
                <h4 class="text-white mb-3">Special Instructions</h4>
                <textarea id="specialInstructions"
                          class="quantum-input w-full h-24"
                          placeholder="Any special requests for your order?"
                          th:text="${specialInstructions}"></textarea>
            </div>
        </div>

        <!-- Right: Order Summary and Address -->
        <div class="lg:col-span-1">
            <div class="glass-panel p-6 sticky top-24">
                <h3 class="text-xl font-bold text-white mb-6">Order Summary</h3>

                <!-- Order Type (Read-only) -->
                <div class="mb-6">
                    <h4 class="text-white mb-3">Order Type</h4>
                    <p class="text-cyber-blue font-semibold" th:text="${orderType}">Delivery</p>
                </div>

                <!-- Delivery Address Section (Visible only for DELIVERY) -->
                <div id="deliveryAddressSection" th:if="${orderType == 'DELIVERY'}" class="mb-6">
                    <h4 class="text-white mb-3">Delivery Address</h4>

                    <!-- No Address Warning -->
                    <div id="noAddressWarning" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg">
                        <p class="text-red-300 text-sm">Please select or add a delivery address</p>
                    </div>

                    <!-- Saved Addresses -->
                    <div th:if="${userAddresses != null && !userAddresses.empty}" class="mb-4">
                        <label class="block text-sm text-gray-300 mb-2">Choose a saved address:</label>
                        <select id="savedAddressSelect"
                                class="quantum-input w-full"
                                onchange="onAddressSelect(this.value)">
                            <option value="">-- Select Address --</option>
                            <option th:each="addr : ${userAddresses}"
                                    th:value="${addr.id}"
                                    th:text="${addr.label + ' - ' + addr.street}">
                            </option>
                            <option value="new">+ Add New Address</option>
                        </select>
                    </div>

                    <!-- New Address Form -->
                    <div id="newAddressForm" class="space-y-3 hidden">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Address Label *</label>
                            <input type="text" id="addressLabel"
                                   class="quantum-input w-full"
                                   placeholder="Home, Work, etc.">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Street Address *</label>
                            <input type="text" id="streetAddress"
                                   class="quantum-input w-full"
                                   placeholder="123 Main Street">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">City *</label>
                            <input type="text" id="city"
                                   class="quantum-input w-full"
                                   placeholder="Athens">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Postal Code *</label>
                            <input type="text" id="postalCode"
                                   class="quantum-input w-full"
                                   placeholder="10431">
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Phone Number</label>
                            <input type="text" id="phoneNumber"
                                   class="quantum-input w-full"
                                   placeholder="+30 123 456 7890">
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveNewAddress()"
                                    class="flex-1 cyber-button-secondary py-2 text-sm">
                                <i class="fas fa-save mr-2"></i>Save Address
                            </button>
                            <button onclick="cancelNewAddress()"
                                    class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 text-sm rounded-lg">
                                Cancel
                            </button>
                        </div>
                    </div>

                    <!-- Current Address Display -->
                    <div id="currentAddressDisplay" class="mt-4 p-3 bg-white/5 rounded-lg hidden">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="text-white font-medium" id="displayLabel"></p>
                                <p class="text-gray-400 text-sm" id="displayStreet"></p>
                                <p class="text-gray-400 text-sm" id="displayCityPostal"></p>
                                <p class="text-gray-400 text-sm" id="displayPhone"></p>
                            </div>
                            <button onclick="changeAddress()" class="text-cyber-blue hover:text-cyber-blue-light text-sm">
                                Change
                            </button>
                        </div>
                        <input type="hidden" id="selectedAddressId">
                    </div>
                </div>

                <!-- Summary Details -->
                <div class="space-y-3 mb-6">
                    <div class="flex justify-between text-gray-300">
                        <span>Subtotal</span>
                        <span>€<span th:text="${#numbers.formatDecimal(cart.subtotal, 1, 2)}">0.00</span></span>
                    </div>
                    <div class="flex justify-between text-gray-300">
                        <span>Delivery Fee</span>
                        <span>€<span th:text="${#numbers.formatDecimal(cart.deliveryTotal, 1, 2)}">0.00</span></span>
                    </div>
                    <div class="flex justify-between text-white font-bold text-xl border-t border-white/10 pt-3">
                        <span>Total</span>
                        <span>€<span th:text="${#numbers.formatDecimal(cart.total, 1, 2)}">0.00</span></span>
                    </div>
                </div>

                <!-- Place Order Button -->
                <button id="placeOrderButton" onclick="validateAndPlaceOrder()" class="cyber-button w-full py-3">
                    Place Order
                </button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/

    // ... (Include similar JS functions as in cart.html for logging, authenticated requests, notifications)

    let selectedAddressId = null;
    let orderType = /*[[${orderType}]]*/ 'DELIVERY';

    function onAddressSelect(value) {
        if (value === 'new') {
            document.getElementById('newAddressForm').classList.remove('hidden');
            document.getElementById('savedAddressSelect').classList.add('hidden');
            return;
        } else if (value === '') {
            selectedAddressId = null;
            document.getElementById('currentAddressDisplay').classList.add('hidden');
            updatePlaceOrderButton();
            return;
        }

        // Fetch address details (assume API /api/addresses/{id})
        makeAuthenticatedRequest('/api/addresses/' + value)
            .then(response => response.json())
            .then(data => {
                selectedAddressId = data.id;
                document.getElementById('displayLabel').textContent = data.label;
                document.getElementById('displayStreet').textContent = data.street;
                document.getElementById('displayCityPostal').textContent = data.city + ', ' + data.postalCode;
                document.getElementById('displayPhone').textContent = data.phoneNumber || '';
                document.getElementById('currentAddressDisplay').classList.remove('hidden');
                document.getElementById('savedAddressSelect').classList.add('hidden');
                updatePlaceOrderButton();
            })
            .catch(error => {
                showNotification('Failed to load address: ' + error.message, 'error');
            });
    }

    function cancelNewAddress() {
        document.getElementById('newAddressForm').classList.add('hidden');
        document.getElementById('savedAddressSelect').classList.remove('hidden');
        // Clear form fields
        document.getElementById('addressLabel').value = '';
        document.getElementById('streetAddress').value = '';
        document.getElementById('city').value = '';
        document.getElementById('postalCode').value = '';
        document.getElementById('phoneNumber').value = '';
    }

    function saveNewAddress() {
        const label = document.getElementById('addressLabel').value.trim();
        const street = document.getElementById('streetAddress').value.trim();
        const city = document.getElementById('city').value.trim();
        const postalCode = document.getElementById('postalCode').value.trim();
        const phone = document.getElementById('phoneNumber').value.trim();

        if (!label || !street || !city || !postalCode) {
            showNotification('Please fill all required fields', 'error');
            return;
        }

        const newAddress = {
            label: label,
            street: street,
            city: city,
            postalCode: postalCode,
            phoneNumber: phone
        };

        makeAuthenticatedRequest('/api/addresses', {
            method: 'POST',
            body: JSON.stringify(newAddress)
        })
            .then(response => response.json())
            .then(data => {
                selectedAddressId = data.id;
                document.getElementById('displayLabel').textContent = data.label;
                document.getElementById('displayStreet').textContent = data.street;
                document.getElementById('displayCityPostal').textContent = data.city + ', ' + data.postalCode;
                document.getElementById('displayPhone').textContent = data.phoneNumber || '';
                document.getElementById('currentAddressDisplay').classList.remove('hidden');
                document.getElementById('newAddressForm').classList.add('hidden');
                document.getElementById('savedAddressSelect').classList.remove('hidden');
                // Add to select
                const select = document.getElementById('savedAddressSelect');
                const option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.label + ' - ' + data.street;
                select.insertBefore(option, select.lastChild);
                select.value = data.id;
                showNotification('Address saved successfully');
                updatePlaceOrderButton();
            })
            .catch(error => {
                showNotification('Failed to save address: ' + error.message, 'error');
            });
    }

    function changeAddress() {
        document.getElementById('currentAddressDisplay').classList.add('hidden');
        document.getElementById('savedAddressSelect').classList.remove('hidden');
        selectedAddressId = null;
        updatePlaceOrderButton();
    }

    function isOrderValid() {
        if (orderType === 'DELIVERY' && !selectedAddressId) {
            return false;
        }
        return true;
    }

    function updatePlaceOrderButton() {
        const button = document.getElementById('placeOrderButton');
        if (isOrderValid()) {
            button.disabled = false;
            button.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            button.disabled = true;
            button.classList.add('opacity-50', 'cursor-not-allowed');
        }
    }

    function validateAndPlaceOrder() {
        if (!isOrderValid()) {
            if (orderType === 'DELIVERY') {
                document.getElementById('noAddressWarning').classList.remove('hidden');
                showNotification('Please select or add a delivery address', 'error');
            }
            return;
        }

        placeOrder();
    }

    function placeOrder() {
        const button = document.getElementById('placeOrderButton');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        button.disabled = true;

        const instructions = document.getElementById('specialInstructions').value;
        const checkoutData = {
            deliveryAddressId: orderType === 'DELIVERY' ? selectedAddressId : null,
            orderType: orderType,
            specialInstructions: instructions
        };

        makeAuthenticatedRequest('/api/cart/checkout', {
            method: 'POST',
            body: JSON.stringify(checkoutData)
        })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => { throw new Error(text || 'HTTP ' + response.status); });
                }
                return response.json();
            })
            .then(data => {
                if (data.orderIds && data.orderIds.length > 0) {
                    if (data.orderIds.length === 1) {
                        showNotification('Order placed successfully! Redirecting...');
                        setTimeout(() => {
                            window.location.href = '/orders/' + data.orderIds[0] + '/confirm';
                        }, 1000);
                    } else {
                        showNotification(data.storeCount + ' orders placed successfully! Redirecting...');
                        setTimeout(() => {
                            window.location.href = '/orders/confirmation?ids=' + data.orderIds.join(',');
                        }, 1000);
                    }
                } else {
                    showNotification('No order IDs returned', 'error');
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                showNotification('Checkout failed: ' + error.message, 'error');
                button.innerHTML = originalText;
                button.disabled = false;
            });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize
        updatePlaceOrderButton();

        // If delivery, show section (already conditional in HTML)
    });

    /*]]>*/
</script>
</body>
</html>
