<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Checkout - StreetFoodGo</title>
</head>
<body>
<main layout:fragment="main">
    <style>
        /* Payment Card Styles - Cyberpunk Theme */
        .payment-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-card:hover {
            border-color: rgba(6, 182, 212, 0.6);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
        }

        .payment-card.selected {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.3);
        }

        .payment-card h5 {
            margin: 0;
            font-size: 1.1rem;
            color: #e2e8f0;
            font-family: 'Rajdhani', sans-serif;
        }

        .payment-card p {
            margin: 5px 0 0 0;
            color: #9ca3af;
            font-size: 0.95rem;
        }

        /* Address Card Styles */
        .address-card {
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .address-card:hover {
            border-color: rgba(6, 182, 212, 0.6);
            box-shadow: 0 0 20px rgba(6, 182, 212, 0.2);
        }

        .address-card.selected {
            border-color: #06b6d4;
            background: rgba(6, 182, 212, 0.1);
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.3);
        }

        .address-card strong {
            color: #e2e8f0;
        }

        .address-card span {
            color: #9ca3af;
        }

        /* Card Form Toggle */
        .card-form {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: rgba(6, 182, 212, 0.05);
            border-radius: 8px;
        }

        .card-form.active {
            display: block;
        }

        /* Cyberpunk Section Headers */
        .checkout-header {
            background: rgba(6, 182, 212, 0.1);
            border-bottom: 2px solid rgba(6, 182, 212, 0.3);
            padding: 15px;
            border-radius: 10px 10px 0 0;
        }

        .checkout-header h5 {
            margin: 0;
            color: #06b6d4;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Form Labels */
        .form-label {
            font-weight: 600;
            color: #e2e8f0;
            margin-bottom: 8px;
            font-family: 'Rajdhani', sans-serif;
        }

        /* Radio/Checkbox styling */
        .form-check-label {
            color: #e2e8f0;
            font-weight: 500;
        }
    </style>
    <div class="max-w-6xl mx-auto">
        <h2 class="text-3xl font-orbitron font-bold text-white mb-8">CHECKOUT</h2>

        <div th:if="${errorMessage}" class="bg-red-900/30 border border-red-500 rounded-lg p-4 mb-6 text-red-200" th:text="${errorMessage}"></div>

        <div class="grid grid-cols-3 gap-6">
            <!-- Left Column: Order Summary -->
            <div class="col-span-2">
                <form method="post" action="/checkout/process" id="checkoutForm">
                    <!-- CSRF Token for Spring Security -->
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                    <!-- Step 1: Order Type -->
                    <div class="glass-panel mb-6">
                        <div class="checkout-header">
                            <h5>1. Delivery Method</h5>
                        </div>
                        <div class="p-6">
                            <div class="space-y-4">
                                <div class="flex items-center">
                                    <input class="form-check-input" type="radio" name="orderType" id="orderTypeDelivery"
                                           value="DELIVERY" required>
                                    <label class="form-check-label ml-3" for="orderTypeDelivery">
                                        <strong>Delivery</strong> - Delivery to your address
                                        <span th:if="${deliveryFee != null and deliveryFee > 0}" class="text-cyber-blue">
                                            (Cost: â‚¬<span th:text="${#numbers.formatDecimal(deliveryFee, 1, 2)}"></span>)
                                        </span>
                                    </label>
                                </div>
                                <div class="flex items-center">
                                    <input class="form-check-input" type="radio" name="orderType" id="orderTypePickup"
                                           value="PICKUP" required checked>
                                    <label class="form-check-label ml-3" for="orderTypePickup">
                                        <strong>Pickup</strong> - Pickup from the store
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Delivery Address (shown only for DELIVERY) -->
                    <div class="glass-panel mb-6" id="deliveryAddressSection" style="display: none;">
                        <div class="checkout-header">
                            <h5>2. Delivery Address</h5>
                        </div>
                        <div class="p-6">
                            <div th:if="${addresses.empty}">
                                <p class="text-gray-400">You have no saved addresses.</p>
                                <a th:href="@{/profile/addresses/new(redirect='/checkout')}" class="cyber-button text-sm mt-4 inline-block">Add Address</a>
                            </div>
                            <div th:unless="${addresses.empty}">
                                <div th:each="address : ${addresses}" class="address-card"
                                     th:data-address-id="${address.id}">
                                    <input type="radio" name="deliveryAddressId" th:value="${address.id}"
                                           th:id="'address-' + ${address.id}" style="display: none;">
                                    <strong th:text="${address.label}"></strong><br>
                                    <span th:text="${address.street}"></span>,
                                    <span th:text="${address.city}"></span>
                                    <span th:text="${address.postalCode}"></span>
                                </div>
                                <a th:href="@{/profile/addresses/new(redirect='/checkout')}" class="cyber-button text-sm mt-4 inline-block">+ Add New Address</a>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Payment Method -->
                    <div class="glass-panel mb-6">
                        <div class="checkout-header">
                            <h5>3. Payment Method</h5>
                        </div>
                        <div class="p-6">
                            <!-- Cash Payment -->
                            <div class="payment-card" data-payment="CASH">
                                <input type="radio" name="paymentMethod" id="paymentCash" value="CASH" required checked>
                                <label for="paymentCash" style="cursor: pointer; width: 100%;">
                                    <h5>ðŸ’µ Cash</h5>
                                    <p class="text-gray-400">Pay with cash on delivery (COD)</p>
                                </label>
                            </div>

                            <!-- Card Payment -->
                            <div class="payment-card" data-payment="CARD">
                                <input type="radio" name="paymentMethod" id="paymentCard" value="CARD">
                                <label for="paymentCard" style="cursor: pointer; width: 100%;">
                                    <h5>ðŸ’³ Credit/Debit Card</h5>
                                    <p class="text-gray-400">Secure payment with card</p>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Step 4: Card Details (Shown only for CARD payment) -->
                    <div class="glass-panel mb-6" id="cardDetailsSection" style="display: none;">
                        <div class="checkout-header">
                            <h5>4. Card Details</h5>
                        </div>
                        <div class="p-6">
                            <input type="hidden" name="savedPaymentMethodId" id="savedPaymentMethodId">

                            <!-- Case 1: No Saved Cards -->
                            <div th:if="${paymentMethods == null || paymentMethods.isEmpty()}">
                                <p class="text-gray-400 text-sm mb-4">You have no saved cards.</p>
                                <button type="button" onclick="toggleNewCardForm(true)" class="cyber-button text-sm inline-block">
                                    <i class="fas fa-plus mr-2"></i> Add New Card
                                </button>
                            </div>

                            <!-- Case 2: Have Saved Cards -->
                            <div th:if="${paymentMethods != null && !paymentMethods.isEmpty()}">
                                <div class="space-y-3 mb-4">
                                    <p class="text-gray-400 text-sm mb-2">Select a saved card:</p>
                                    <div th:each="method : ${paymentMethods}" class="flex items-center p-3 border border-white/10 rounded-lg cursor-pointer hover:bg-white/5"
                                         th:onclick="'selectSavedCard(' + ${method.id} + ')'">
                                        <input type="radio" name="cardSelection" th:id="'savedCard_' + ${method.id}"
                                               class="form-radio text-cyber-blue"
                                               th:value="${method.id}">
                                        <label th:for="'savedCard_' + ${method.id}" class="ml-3 flex-grow cursor-pointer">
                                            <span class="text-white font-semibold" th:text="${method.label}">Visa â€¢â€¢â€¢â€¢ 1234</span>
                                            <span class="text-gray-400 text-sm block" th:text="${'Expires ' + method.expiryMonth + '/' + method.expiryYear}"></span>
                                        </label>
                                        <i th:class="${'text-2xl ' + (method.cardBrand == 'Visa' ? 'fab fa-cc-visa text-blue-400' : 'fab fa-cc-mastercard text-red-400')}"></i>
                                    </div>
                                </div>
                                <button type="button" onclick="toggleNewCardForm(true)" class="cyber-button text-sm mt-2 inline-block">
                                    <i class="fas fa-plus mr-2"></i> Add New Card
                                </button>
                            </div>

                            <!-- Hidden Radio for new card logic -->
                            <input type="radio" name="cardSelection" id="useNewCard" value="new" style="display:none">

                            <!-- New Card Form Container -->
                            <div id="newCardDetails" style="display: none; margin-top: 20px;">
                                <div class="space-y-4 p-4 border border-white/10 rounded-lg bg-white/5">
                                    <div class="flex justify-between items-center mb-4">
                                        <h6 class="text-white font-semibold m-0">Enter Card Details</h6>
                                        <button type="button" onclick="document.getElementById('newCardDetails').style.display='none'" class="text-gray-400 hover:text-white">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div>
                                        <label for="cardNumber" class="block text-white font-semibold mb-2">Card Number</label>
                                        <input type="text" class="quantum-input w-full" id="cardNumber" name="cardNumber"
                                               placeholder="1234 5678 9012 3456" maxlength="19" disabled>
                                    </div>
                                    <div>
                                        <label for="cardHolderName" class="block text-white font-semibold mb-2">Cardholder Name</label>
                                        <input type="text" class="quantum-input w-full" id="cardHolderName" name="cardHolderName"
                                               placeholder="NAME SURNAME" disabled>
                                    </div>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-white font-semibold mb-2">Expiry Month</label>
                                            <select class="quantum-input w-full" id="expiryMonth" name="expiryMonth" disabled>
                                                <option value="">Month</option>
                                                <option th:each="i : ${#numbers.sequence(1, 12)}"
                                                        th:value="${i}" th:text="${#numbers.formatInteger(i, 2)}"></option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="block text-white font-semibold mb-2">Expiry Year</label>
                                            <select class="quantum-input w-full" id="expiryYear" name="expiryYear" disabled>
                                                <option value="">Year</option>
                                                <option th:each="i : ${#numbers.sequence(2024, 2034)}"
                                                        th:value="${i}" th:text="${i}"></option>
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="cvv" class="block text-white font-semibold mb-2">CVV</label>
                                        <input type="text" class="quantum-input w-full" id="cvv" name="cvv"
                                               placeholder="123" maxlength="3" disabled>
                                    </div>
                                    <div class="flex items-center mt-3">
                                        <input type="checkbox" id="saveCard" name="saveCard" class="form-checkbox text-cyber-blue">
                                        <label for="saveCard" class="ml-2 text-gray-300">Save this card for future use</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <!-- PLACE ORDER BUTTON - Very Prominent! -->
                    <button type="submit" class="cyber-button w-full text-lg py-4">
                        <i class="fas fa-shopping-bag mr-2"></i> Place Order - â‚¬<span id="finalTotal" th:text="${#numbers.formatDecimal(total, 1, 2)}"></span>
                    </button>
                </form>
            </div>

            <!-- Right Column: Cart Summary -->
            <div class="col-span-1">
                <div class="glass-panel sticky top-32">
                    <div class="checkout-header">
                        <h5>Order Summary</h5>
                    </div>
                    <div class="p-6">
                        <h6 class="text-white font-rajdhani text-lg mb-4" th:text="${store.name}"></h6>
                        <div class="border-b border-white/10 mb-4"></div>

                        <div th:each="item : ${cartDetails}" class="mb-3">
                            <div class="flex justify-between text-gray-300">
                                <div>
                                    <strong th:text="${item.cartLine.quantity} + 'x ' + ${item.cartLine.name}"></strong>
                                </div>
                                <div>
                                    â‚¬<span th:text="${#numbers.formatDecimal(item.cartLine.totalPrice, 1, 2)}"></span>
                                </div>
                            </div>
                        </div>

                        <div class="border-b border-white/10 my-4"></div>
                        <div class="space-y-2 text-gray-300">
                            <div class="flex justify-between">
                                <span>Subtotal:</span>
                                <span>â‚¬<span th:text="${#numbers.formatDecimal(subtotal, 1, 2)}"></span></span>
                            </div>
                            <div class="flex justify-between" id="deliveryFeeRow" style="display: none;">
                                <span>Delivery Fee:</span>
                                <span>â‚¬<span id="deliveryFeeAmount" th:text="${#numbers.formatDecimal(deliveryFee, 1, 2)}"></span></span>
                            </div>
                        </div>
                        <div class="border-b border-white/10 my-4"></div>
                        <div class="flex justify-between text-cyber-blue font-rajdhani text-lg">
                            <strong>Total:</strong>
                            <strong>â‚¬<span id="totalAmount" th:text="${#numbers.formatDecimal(total, 1, 2)}"></span></strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const orderSubtotal = /*[[${subtotal}]]*/ 0;
        const orderDeliveryFee = /*[[${deliveryFee}]]*/ 0;

        // Define functions globally for onclick handlers
        function selectSavedCard(id) {
            document.getElementById('savedPaymentMethodId').value = id;
            const radio = document.getElementById('savedCard_' + id);
            if(radio) radio.checked = true;

            document.getElementById('newCardDetails').style.display = 'none';
            toggleNewCardInputs(false);
        }

        function toggleNewCardForm(show) {
            document.getElementById('savedPaymentMethodId').value = '';
            const radio = document.getElementById('useNewCard');
            if(radio) radio.checked = true;

            document.getElementById('newCardDetails').style.display = 'block';
            toggleNewCardInputs(true);
        }

        function toggleNewCardInputs(enable) {
            const inputs = document.querySelectorAll('#newCardDetails input:not([type="checkbox"]), #newCardDetails select');
            inputs.forEach(input => {
                if (enable) {
                    input.removeAttribute('disabled');
                    input.required = true;
                } else {
                    input.setAttribute('disabled', 'disabled');
                    input.required = false;
                }
            });
        }

        function updateTotal(total) {
            document.getElementById('totalAmount').textContent = total.toFixed(2);
            document.getElementById('finalTotal').textContent = total.toFixed(2);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Handle order type change
            document.querySelectorAll('input[name="orderType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const deliverySection = document.getElementById('deliveryAddressSection');
                    const deliveryFeeRow = document.getElementById('deliveryFeeRow');

                    if (this.value === 'DELIVERY') {
                        deliverySection.style.display = 'block';
                        deliveryFeeRow.style.display = 'flex';
                        updateTotal(orderSubtotal + orderDeliveryFee);
                    } else {
                        deliverySection.style.display = 'none';
                        deliveryFeeRow.style.display = 'none';
                        updateTotal(orderSubtotal);
                    }
                });
            });

            // Handle payment method selection
            document.querySelectorAll('.payment-card').forEach(card => {
                card.addEventListener('click', function() {
                    const payment = this.getAttribute('data-payment');
                    const radio = document.getElementById('payment' + payment.charAt(0) + payment.slice(1).toLowerCase());
                    if(radio) radio.checked = true;

                    // Remove selected class from all cards
                    document.querySelectorAll('.payment-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');

                    // Show/hide card details section (Step 4)
                    const cardSection = document.getElementById('cardDetailsSection');
                    if (payment === 'CARD') {
                        cardSection.style.display = 'block';

                        // Check logic based on saved card selection state
                        const savedId = document.getElementById('savedPaymentMethodId').value;
                        toggleNewCardInputs(savedId === '');
                    } else {
                        cardSection.style.display = 'none';
                        // Disable and remove required from card inputs when not paying with card
                        toggleNewCardInputs(false);
                    }
                });
            });

            // Handle address selection
            document.querySelectorAll('.address-card').forEach(card => {
                card.addEventListener('click', function() {
                    const addressId = this.getAttribute('data-address-id');
                    const radio = document.getElementById('address-' + addressId);
                    radio.checked = true;

                    // Remove selected class from all cards
                    document.querySelectorAll('.address-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                });
            });

            // Initialize: select first payment method
            const initialPaymentRadio = document.querySelector('input[name="paymentMethod"]:checked');
            if (initialPaymentRadio) {
                const paymentType = initialPaymentRadio.value;
                const card = document.querySelector(`.payment-card[data-payment="${paymentType}"]`);
                if(card) {
                    // Trigger the click logic to set up UI
                    card.classList.add('selected');

                    const cardSection = document.getElementById('cardDetailsSection');
                    if (paymentType === 'CARD') {
                        cardSection.style.display = 'block';
                        const savedId = document.getElementById('savedPaymentMethodId').value;
                        toggleNewCardInputs(savedId === '');
                    } else {
                        cardSection.style.display = 'none';
                        toggleNewCardInputs(false);
                    }
                }
            } else {
                // Default fallback
                const cashCard = document.querySelector('.payment-card[data-payment="CASH"]');
                if(cashCard) {
                    cashCard.classList.add('selected');
                    const cashRadio = document.getElementById('paymentCash');
                    if(cashRadio) cashRadio.checked = true;
                    toggleNewCardInputs(false);
                }
            }

            // Initialize: Auto-select default address
            const addresses = document.querySelectorAll('.address-card');
            if (addresses.length > 0) {
                // Check if any is already checked (from reload)
                const checked = document.querySelector('input[name="deliveryAddressId"]:checked');
                if (checked) {
                    const card = document.querySelector(`.address-card[data-address-id="${checked.value}"]`);
                    if(card) card.classList.add('selected');
                } else {
                    const firstAddress = addresses[0];
                    if(firstAddress) firstAddress.click();
                }
            }

            // Initialize: Update UI based on initial order type
            const checkedOrderType = document.querySelector('input[name="orderType"]:checked');
            if (checkedOrderType) {
                const event = new Event('change');
                checkedOrderType.dispatchEvent(event);
            }

            // Initial state logic for saved payment methods if CARD is selected (and no specific saved card is selected)
            /*[# th:if="${paymentMethods != null && !paymentMethods.isEmpty()}"]*/
            if (!document.getElementById('savedPaymentMethodId').value) {
                const firstCardId = /*[[${paymentMethods[0].id}]]*/ 0;
                selectSavedCard(firstCardId);
            }
            /*[/]*/
        });
        /*]]>*/
    </script>
</main>
</body>
</html>

