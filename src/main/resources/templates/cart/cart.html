<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Shopping Cart</title>
    <!-- CSRF Meta Tags -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>
<div layout:fragment="main">
    <!-- Cart Header -->
    <div class="glass-panel p-8 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-orbitron font-bold text-white mb-2">Shopping Cart</h1>
                <p class="text-gray-400">Review your order before checkout</p>
            </div>
            <div class="text-right" th:if="${cart != null && cart.items != null && !cart.items.empty}">
                <p class="text-gray-400">Items in cart</p>
                <p class="text-2xl font-bold text-cyber-blue" th:text="${cart.items.size()}">0</p>
            </div>
        </div>
    </div>

    <!-- Empty Cart -->
    <div th:if="${cart == null || cart.storeGroups == null || cart.storeGroups.empty}" class="glass-panel p-12 text-center">
        <i class="fas fa-shopping-cart text-4xl text-gray-500 mb-4"></i>
        <h3 class="text-xl font-bold text-white mb-2">Your cart is empty</h3>
        <p class="text-gray-400 mb-6">Add delicious items from our stores</p>
        <a th:href="@{/stores}" class="cyber-button inline-block">
            <i class="fas fa-store mr-2"></i>Browse Stores
        </a>
    </div>

    <!-- Cart with Items -->
    <div th:if="${cart != null && cart.storeGroups != null && !cart.storeGroups.empty}"
         class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <!-- Left: Cart Items -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Store Grouping -->
            <div th:each="storeGroup : ${cart.storeGroups}"
                 class="glass-panel p-6 store-group"
                 th:data-store-id="${storeGroup.storeId}">

                <div class="flex items-center mb-6">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-cyber-blue/20 to-quantum/20
                                flex items-center justify-center mr-3">
                        <i class="fas fa-store text-cyber-blue"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white" th:text="${storeGroup.storeName}">Store</h3>
                        <p class="text-gray-400 text-sm" th:text="${storeGroup.storeArea}">Area</p>
                    </div>
                </div>

                <!-- Items -->
                <div th:each="item, iterStat : ${storeGroup.items}"
                     th:class="${!iterStat.last ? 'border-b border-white/10 pb-6 mb-6' : 'pb-2'}">

                    <div class="flex justify-between items-start mb-3">
                        <div class="flex-grow">
                            <h4 class="font-bold text-white" th:text="${item.name}">Item</h4>
                            <p class="text-gray-400 text-sm" th:text="${item.description}">Description</p>
                        </div>
                        <button class="text-red-400 hover:text-red-300 transition-colors ml-4 remove-btn"
                                th:attr="data-item-id=${item.id}"
                                onclick="removeItem(this.getAttribute('data-item-id'))">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>

                    <div class="flex items-center justify-between">
                        <!-- Quantity Controls -->
                        <div class="flex items-center gap-3">
                            <button class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20
                                         flex items-center justify-center text-white transition-colors quantity-btn"
                                    th:attr="data-item-id=${item.id}, data-change='-1'"
                                    onclick="updateQuantity(this.getAttribute('data-item-id'), -1)">
                                <i class="fas fa-minus text-sm"></i>
                            </button>
                            <span class="text-white font-bold min-w-[2rem] text-center"
                                  th:text="${item.quantity}">1</span>
                            <button class="w-8 h-8 rounded-full bg-white/10 hover:bg-white/20
                                         flex items-center justify-center text-white transition-colors quantity-btn"
                                    th:attr="data-item-id=${item.id}, data-change='1'"
                                    onclick="updateQuantity(this.getAttribute('data-item-id'), 1)">
                                <i class="fas fa-plus text-sm"></i>
                            </button>
                        </div>

                        <!-- Price -->
                        <div class="text-right">
                            <p class="text-xl font-bold text-cyber-blue">
                                ‚Ç¨<span th:text="${item.totalPrice}">0.00</span>
                            </p>
                            <p class="text-gray-400 text-sm">
                                ‚Ç¨<span th:text="${item.unitPrice}">0.00</span> each
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Store Minimum Order Warning -->
                <div th:if="${storeGroup.subtotal < storeGroup.minimumOrder}"
                     class="mt-6 p-4 bg-yellow-500/20 border border-yellow-500/50 rounded-lg">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-3"></i>
                        <p class="text-yellow-300 text-sm">
                            Minimum order is ‚Ç¨<span th:text="${storeGroup.minimumOrder}">0</span>.
                            Add ‚Ç¨<span th:text="${#numbers.formatDecimal(storeGroup.minimumOrder - storeGroup.subtotal, 1, 2)}">0</span> more.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Order Summary -->
        <div class="lg:col-span-1">
            <div class="glass-panel p-6 sticky top-24">
                <h3 class="text-xl font-bold text-white mb-6">Order Summary</h3>

                <!-- Order Type -->
                <div class="mb-6">
                    <h4 class="text-white mb-3">Order Type</h4>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="deliveryBtn"
                                class="py-3 rounded-lg border text-center border-cyber-blue bg-cyber-blue/10 text-cyber-blue transition-colors"
                                onclick="setOrderType('DELIVERY')">
                            <i class="fas fa-truck mb-1 block"></i>
                            <p class="font-semibold text-sm">Delivery</p>
                        </button>
                        <button id="pickupBtn"
                                class="py-3 rounded-lg border text-center border-white/10 text-gray-300 hover:border-white/20 transition-colors"
                                onclick="setOrderType('PICKUP')">
                            <i class="fas fa-walking mb-1 block"></i>
                            <p class="font-semibold text-sm">Pickup</p>
                        </button>
                    </div>
                </div>

                <!-- Summary Details -->
                <div class="space-y-3 mb-6">
                    <div th:each="storeGroup : ${cart.storeGroups}">
                        <div class="flex justify-between text-sm">
                            <span class="text-gray-300" th:text="${storeGroup.storeName}">Store</span>
                            <span class="text-white">‚Ç¨<span th:text="${#numbers.formatDecimal(storeGroup.subtotal, 1, 2)}">0</span></span>
                        </div>
                        <div class="flex justify-between text-xs text-gray-500 ml-4">
                            <span>Delivery fee</span>
                            <span>‚Ç¨<span th:text="${#numbers.formatDecimal(storeGroup.deliveryFee, 1, 2)}">0</span></span>
                        </div>
                    </div>

                    <div class="border-t border-white/10 pt-3">
                        <div class="flex justify-between text-gray-300 text-sm">
                            <span>Subtotal</span>
                            <span>‚Ç¨<span th:text="${#numbers.formatDecimal(cart.subtotal, 1, 2)}">0</span></span>
                        </div>
                        <div class="flex justify-between text-gray-300 text-sm">
                            <span>Delivery Total</span>
                            <span>‚Ç¨<span th:text="${#numbers.formatDecimal(cart.deliveryTotal, 1, 2)}">0</span></span>
                        </div>
                    </div>

                    <div class="border-t border-white/10 pt-3">
                        <div class="flex justify-between text-xl font-bold">
                            <span class="text-white">Total</span>
                            <span class="text-cyber-blue">‚Ç¨<span th:text="${#numbers.formatDecimal(cart.total, 1, 2)}">0</span></span>
                        </div>
                    </div>
                </div>

                <!-- Special Instructions -->
                <div class="mb-6">
                    <label class="block text-sm text-gray-300 mb-2">Special Instructions</label>
                    <textarea id="specialInstructions"
                              class="quantum-input w-full"
                              rows="3"
                              placeholder="Any special requests..."></textarea>
                </div>

                <!-- Checkout Button -->
                <button id="checkoutButton" class="w-full cyber-button py-3" onclick="checkout()">
                    <i class="fas fa-lock mr-2"></i>Proceed to Checkout
                </button>
            </div>
        </div>
    </div>
</div>

<script th:inline="none">
    // ==================== CSRF UTILITIES ====================
    function getCsrfToken() {
        const metaTag = document.querySelector('meta[name="_csrf"]');
        if (metaTag && metaTag.content) {
            return metaTag.content;
        }
        const cookieMatch = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
        if (cookieMatch && cookieMatch[1]) {
            return decodeURIComponent(cookieMatch[1]);
        }
        return '';
    }

    function getCsrfHeaderName() {
        const metaTag = document.querySelector('meta[name="_csrf_header"]');
        return (metaTag && metaTag.content) ? metaTag.content : 'X-CSRF-TOKEN';
    }

    function makeAuthenticatedRequest(url, options = {}) {
        const csrfToken = getCsrfToken();
        const csrfHeader = getCsrfHeaderName();

        const defaultHeaders = {
            'Accept': 'application/json',
            'X-Requested-With': 'XMLHttpRequest',
            [csrfHeader]: csrfToken
        };

        const method = (options.method || 'GET').toUpperCase();
        if (['POST', 'PUT', 'PATCH', 'DELETE'].includes(method)) {
            defaultHeaders['Content-Type'] = 'application/json';
        }

        return fetch(url, {
            ...options,
            headers: {
                ...defaultHeaders,
                ...options.headers
            },
            credentials: 'same-origin'
        });
    }

    // ==================== CART FUNCTIONS ====================
    let orderType = 'DELIVERY';

    function updateQuantity(itemId, change) {
        console.log('üîÑ Updating quantity for item', itemId, 'change:', change);

        makeAuthenticatedRequest('/api/cart/items/' + itemId + '/quantity', {
            method: 'PUT',
            body: JSON.stringify({ change: change })
        })
            .then(function(response) {
                if (!response.ok) {
                    return response.text().then(function(text) {
                        throw new Error(text || 'HTTP ' + response.status);
                    });
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ Quantity updated:', data);
                showNotification('Quantity updated successfully');

                setTimeout(function() {
                    window.location.reload();
                }, 500);
            })
            .catch(function(error) {
                console.error('‚ùå Error updating quantity:', error);
                showNotification('‚ùå Failed to update quantity: ' + error.message, 'error');
            });
    }

    function removeItem(itemId) {
        if (!confirm('Are you sure you want to remove this item from your cart?')) {
            return;
        }

        console.log('üóëÔ∏è Removing item:', itemId);

        makeAuthenticatedRequest('/api/cart/items/' + itemId, {
            method: 'DELETE'
        })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ Item removed:', data);
                showNotification('Item removed from cart');

                setTimeout(function() {
                    window.location.reload();
                }, 500);
            })
            .catch(function(error) {
                console.error('‚ùå Error removing item:', error);
                showNotification('‚ùå Failed to remove item: ' + error.message, 'error');
            });
    }

    function setOrderType(type) {
        console.log('üì¶ Setting order type:', type);
        orderType = type;

        const deliveryBtn = document.getElementById('deliveryBtn');
        const pickupBtn = document.getElementById('pickupBtn');

        if (type === 'DELIVERY') {
            deliveryBtn.className = 'py-3 rounded-lg border text-center border-cyber-blue bg-cyber-blue/10 text-cyber-blue transition-colors';
            pickupBtn.className = 'py-3 rounded-lg border text-center border-white/10 text-gray-300 hover:border-white/20 transition-colors';
        } else {
            pickupBtn.className = 'py-3 rounded-lg border text-center border-cyber-blue bg-cyber-blue/10 text-cyber-blue transition-colors';
            deliveryBtn.className = 'py-3 rounded-lg border text-center border-white/10 text-gray-300 hover:border-white/20 transition-colors';
        }

        makeAuthenticatedRequest('/api/cart/order-type', {
            method: 'PUT',
            body: JSON.stringify({ orderType: type })
        })
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status);
                }
                console.log('‚úÖ Order type saved to session');
            })
            .catch(function(error) {
                console.error('‚ùå Error saving order type:', error);
            });
    }

    function checkout() {
        console.log('üí∞ Starting checkout process');

        const checkoutBtn = document.getElementById('checkoutButton');
        const originalText = checkoutBtn.innerHTML;
        checkoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
        checkoutBtn.disabled = true;

        const instructions = document.getElementById('specialInstructions').value;

        makeAuthenticatedRequest('/api/cart/checkout', {
            method: 'POST',
            body: JSON.stringify({
                deliveryAddressId: null,
                orderType: orderType,
                specialInstructions: instructions
            })
        })
            .then(function(response) {
                if (!response.ok) {
                    return response.text().then(function(text) {
                        throw new Error(text || 'HTTP ' + response.status);
                    });
                }
                return response.json();
            })
            .then(function(data) {
                console.log('‚úÖ Checkout successful:', data);

                if (data.orderIds && data.orderIds.length > 0) {
                    if (data.orderIds.length === 1) {
                        showNotification('Order placed successfully! Redirecting...');
                        setTimeout(function() {
                            window.location.href = '/orders/' + data.orderIds[0] + '/confirm';
                        }, 1000);
                    } else {
                        showNotification(data.storeCount + ' orders placed successfully! Redirecting...');
                        setTimeout(function() {
                            window.location.href = '/orders/confirmation?ids=' + data.orderIds.join(',');
                        }, 1000);
                    }
                } else {
                    showNotification('‚ùå No order IDs returned', 'error');
                    checkoutBtn.innerHTML = originalText;
                    checkoutBtn.disabled = false;
                }
            })
            .catch(function(error) {
                console.error('‚ùå Checkout failed:', error);
                showNotification('‚ùå Checkout failed: ' + error.message, 'error');
                checkoutBtn.innerHTML = originalText;
                checkoutBtn.disabled = false;
            });
    }

    function showNotification(message, type = 'success') {
        const icon = type === 'error' ? 'fa-exclamation-circle' : 'fa-check-circle';
        const bgColor = type === 'error' ? 'bg-red-500/20 border-red-500/50' : 'bg-green-500/20 border-green-500/50';
        const textColor = type === 'error' ? 'text-red-300' : 'text-green-300';

        const notification = document.createElement('div');
        notification.className = `fixed top-6 right-6 z-50 px-6 py-4 ${bgColor} border ${textColor}
                                 rounded-lg shadow-xl transform transition-all duration-300 translate-x-full`;
        notification.innerHTML = `
            <div class="flex items-center">
                <i class="fas ${icon} mr-3"></i>
                <span class="font-medium">${message}</span>
            </div>
        `;

        document.body.appendChild(notification);

        setTimeout(() => notification.classList.remove('translate-x-full'), 10);

        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }

    // ==================== INITIALIZATION ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üõí Cart page loaded');

        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('orderType')) {
            setOrderType(urlParams.get('orderType'));
        }

        console.log('üîê CSRF Token:', getCsrfToken() ? '‚úì Loaded' : '‚úó Not found');
    });
</script>
</body>
</html>
