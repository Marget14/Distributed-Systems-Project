<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Store Orders</title>
</head>
<body>
<div layout:fragment="main">
    <!-- Store Orders Header -->
    <div class="glass-panel p-8 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-orbitron font-bold text-white mb-2">
                    Orders - <span th:text="${store.name}">Store</span>
                </h1>
                <p class="text-gray-400">Manage your store orders</p>
            </div>
            <a th:href="@{/owner/dashboard}" class="cyber-button inline-block opacity-60 hover:opacity-80">
                <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="glass-panel p-6 mb-6">
        <div class="flex gap-3 flex-wrap">
            <a th:href="@{/owner/stores/{id}/orders(id=${store.id})}"
               th:classappend="${selectedStatus == null ? 'cyber-button' : 'cyber-button inline-block opacity-60 hover:opacity-80'}"
               class="px-4 py-2">
                All Orders
            </a>
            <a th:each="status : ${orderStatuses}"
               th:href="@{/owner/stores/{id}/orders(id=${store.id}, status=${status})}"
               th:classappend="${selectedStatus == status ? 'cyber-button' : 'cyber-button inline-block opacity-60 hover:opacity-80'}"
               class="px-4 py-2"
               th:text="${status}">
                Status
            </a>
        </div>
    </div>

    <!-- Orders List -->
    <div th:if="${orders.isEmpty()}" class="glass-panel p-12 text-center">
        <i class="fas fa-receipt text-4xl text-gray-500 mb-4"></i>
        <h3 class="text-xl font-bold text-white mb-2">No orders found</h3>
        <p class="text-gray-400">Orders will appear here when customers place them</p>
    </div>

    <div th:if="${!orders.isEmpty()}" class="space-y-4">
        <div th:each="order : ${orders}" class="glass-panel p-6">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 class="text-xl font-bold text-white mb-1">
                        Order #<span th:text="${order.id}">1</span>
                    </h3>
                    <p class="text-gray-400 text-sm">
                        <i class="fas fa-user mr-1"></i>
                        Customer ID: <span th:text="${order.customer != null ? order.customer.id : 'Unknown'}">1</span>
                    </p>
                    <p class="text-gray-400 text-sm">
                        <i class="fas fa-clock mr-1"></i>
                        <span th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm') : ''}">Date</span>
                    </p>
                </div>
                <div class="text-right" th:with="statusStr=${#strings.toString(order.status)}">
                    <span th:if="${statusStr == 'PENDING'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-yellow-500/20 text-yellow-300" th:text="${order.status}">PENDING</span>
                    <span th:if="${statusStr == 'PREPARING'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-purple-500/20 text-purple-300" th:text="${order.status}">PREPARING</span>
                    <span th:if="${statusStr == 'READY'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-500/20 text-green-300" th:text="${order.status}">READY</span>
                    <span th:if="${statusStr == 'DELIVERING'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-cyan-500/20 text-cyan-300" th:text="${order.status}">DELIVERING</span>
                    <span th:if="${statusStr == 'COMPLETED'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-500/20 text-green-300" th:text="${order.status}">COMPLETED</span>
                    <span th:if="${statusStr != 'PENDING' and statusStr != 'PREPARING' and statusStr != 'READY' and statusStr != 'DELIVERING' and statusStr != 'COMPLETED'}"
                          class="px-3 py-1 rounded-full text-sm font-semibold bg-red-500/20 text-red-300" th:text="${order.status}">OTHER</span>
                    <p class="text-2xl font-bold text-cyber-blue mt-2">
                        â‚¬<span th:text="${order.total != null ? #numbers.formatDecimal(order.total, 1, 2) : '0.00'}">0.00</span>
                    </p>
                </div>
            </div>

            <!-- Order Items -->
            <div class="border-t border-white/10 pt-4 mb-4" th:if="${order.items != null}">
                <h4 class="text-white font-semibold mb-2">Items:</h4>
                <div class="space-y-2">
                    <div th:each="item : ${order.items}" class="flex justify-between text-sm">
                        <span class="text-gray-300">
                            <span th:text="${item.quantity}">1</span>x
                            <span th:text="${item.menuItem != null ? item.menuItem.name : 'Deleted Item'}">Item</span>
                        </span>
                        <span class="text-gray-400">
                            â‚¬<span th:text="${item.priceAtOrder != null ? #numbers.formatDecimal(item.priceAtOrder, 1, 2) : '0.00'}">0.00</span>
                        </span>
                    </div>
                </div>
            </div>

            <!-- Order Type & Address -->
            <div class="border-t border-white/10 pt-4 mb-4">
                <p class="text-gray-300 text-sm flex items-center">
                    <span th:if="${order.orderType != null && order.orderType.name() == 'DELIVERY'}" class="inline-flex items-center text-cyber-blue mr-2">
                        <i class="fas fa-truck mr-1"></i>
                    </span>
                    <span th:if="${order.orderType != null && order.orderType.name() == 'PICKUP'}" class="inline-flex items-center text-cyber-blue mr-2">
                        <i class="fas fa-walking mr-1"></i>
                    </span>
                    <span th:text="${order.orderType}">Type</span>
                </p>
                <p th:if="${order.deliveryAddress != null}" class="text-gray-400 text-sm mt-1">
                    <i class="fas fa-map-marker-alt mr-2"></i>
                    <span th:text="${order.deliveryAddress.street + ', ' + order.deliveryAddress.city}">Address</span>
                </p>

                <!-- Mini Map (Removed for performance) -->
                <div th:if="${#strings.toString(order.orderType) == 'DELIVERY' and order.deliveryAddress != null}">
                     <p class="text-xs text-gray-500 mt-1">
                        <i class="fas fa-route mr-1"></i>
                        Distance: <span th:text="${order.estimatedDeliveryDistanceKm != null ? #numbers.formatDecimal(order.estimatedDeliveryDistanceKm, 1, 2) + ' km' : 'N/A'}">N/A</span>
                        â€¢ ETA: <span th:text="${order.estimatedDeliveryMinutes != null ? order.estimatedDeliveryMinutes + ' min' : 'N/A'}">N/A</span>
                    </p>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex gap-2 mt-4 flex-wrap">
                <!-- Track Button (always visible for accepted orders) -->
                <a th:if="${order.status != null && order.status.name() != 'PENDING' && order.status.name() != 'REJECTED'}"
                   th:href="@{/owner/orders/{id}/tracking(id=${order.id})}"
                   class="bg-cyber-blue/20 hover:bg-cyber-blue/30 text-cyber-blue py-2 px-4 rounded-lg transition-colors inline-flex items-center">
                    <i class="fas fa-route mr-2"></i>Track
                </a>

                <!-- Accept button -->
                <form th:if="${order.status != null && order.status.name() == 'PENDING'}"
                      th:action="@{/owner/orders/{id}/accept(id=${order.id})}"
                      method="post" class="inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <button type="submit" class="cyber-button py-2 px-4">
                        <i class="fas fa-check mr-1"></i>Accept
                    </button>
                </form>

                <button th:if="${order.status != null && order.status.name() == 'PENDING'}"
                        th:onclick="'showRejectModal(' + ${order.id} + ')'"
                        class="bg-red-500/20 hover:bg-red-500/30 text-red-300 py-2 px-4 rounded-lg transition-colors">
                    <i class="fas fa-times mr-1"></i>Reject
                </button>

                <form th:if="${order.status != null && order.status.name() == 'PREPARING'}"
                      th:action="@{/owner/orders/{id}/update-status(id=${order.id})}"
                      method="post" class="inline">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="newStatus" value="READY" />
                    <button type="submit" class="cyber-button py-2 px-4">
                        <i class="fas fa-check-circle mr-1"></i>Mark Ready
                    </button>
                </form>

                <form th:if="${order.status != null && order.status.name() == 'READY' && order.orderType != null && order.orderType.name() == 'PICKUP'}"
                     th:action="@{/owner/orders/{id}/update-status(id=${order.id})}"
                     method="post" class="inline">
                   <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                   <input type="hidden" name="newStatus" value="COMPLETED" />
                   <button type="submit" class="cyber-button py-2 px-4">
                       <i class="fas fa-handshake mr-1"></i>Picked Up
                   </button>
               </form>

               <form th:if="${order.status != null && order.status.name() == 'READY' && order.orderType != null && order.orderType.name() == 'DELIVERY'}"
                     th:action="@{/owner/orders/{id}/update-status(id=${order.id})}"
                     method="post" class="inline">
                   <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                   <input type="hidden" name="newStatus" value="DELIVERING" />
                   <button type="submit" class="cyber-button py-2 px-4">
                       <i class="fas fa-truck mr-1"></i>Start Delivery
                   </button>
               </form>

               <form th:if="${order.status != null && order.status.name() == 'DELIVERING'}"
                     th:action="@{/owner/orders/{id}/update-status(id=${order.id})}"
                     method="post" class="inline">
                   <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                   <input type="hidden" name="newStatus" value="COMPLETED" />
                   <button type="submit" class="cyber-button py-2 px-4">
                       <i class="fas fa-flag-checkered mr-1"></i>Delivered
                   </button>
               </form>
            </div>
        </div>
    </div>

    <!-- Reject Modal -->
    <div id="rejectModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="glass-panel p-6 max-w-md w-full">
            <h3 class="text-xl font-bold text-white mb-4">Reject Order</h3>
            <form id="rejectForm" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <input type="hidden" name="orderId" id="rejectOrderId" />
                <div class="mb-4">
                    <label class="block text-white mb-2">Reason for rejection *</label>
                    <textarea name="reason" required
                              class="quantum-input w-full h-24"
                              placeholder="e.g., Out of ingredients, Store closing early..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="button" onclick="closeRejectModal()"
                            class="flex-1 bg-white/10 hover:bg-white/20 text-white py-2 rounded-lg">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="flex-1 bg-red-500/20 hover:bg-red-500/30 text-red-300 py-2 rounded-lg">
                        Reject Order
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script th:inline="javascript">
        const storeId = /*[[${store.id}]]*/ 0;
        const currentOrdersCount = /*[[${orders != null ? orders.size() : 0}]]*/ 0;
        // Avoid complex SpEL filtering here to prevent rendering errors.
        // The auto-refresh logic will fetch the accurate pending count shortly.
        const currentPendingCount = 0;
        let lastKnownPendingCount = currentPendingCount;

        function showRejectModal(orderId) {
            document.getElementById('rejectOrderId').value = orderId;
            document.getElementById('rejectForm').action = '/owner/orders/' + orderId + '/reject';
            document.getElementById('rejectModal').classList.remove('hidden');
        }

        function closeRejectModal() {
            document.getElementById('rejectModal').classList.add('hidden');
        }

        // Notification sound (using Web Audio API)
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);

                console.log('ðŸ”” Notification sound played');
            } catch (error) {
                console.log('Could not play sound:', error);
            }
        }

        // Show notification banner
        function showNotification(text) {
            const notification = document.getElementById('newOrderNotification');
            const notificationText = document.getElementById('notificationText');

            notificationText.textContent = text;
            notification.style.display = 'block';

            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }

        // Check for new orders
        async function checkForNewOrders() {
            try {
                const response = await fetch(`/owner/stores/${storeId}/orders?status=PENDING`, {
                    headers: {
                        'Accept': 'text/html'
                    }
                });

                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const ordersElements = doc.querySelectorAll('.glass-panel');
                    const newPendingCount = ordersElements.length - 1; // Exclude header panel

                    if (newPendingCount > lastKnownPendingCount) {
                        const diff = newPendingCount - lastKnownPendingCount;
                        console.log(`ðŸ”” ${diff} new order(s) detected!`);
                        playNotificationSound();
                        showNotification(`${diff} new order${diff > 1 ? 's' : ''} received!`);

                        // Optionally reload page
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }

                    lastKnownPendingCount = newPendingCount;
                }
            } catch (error) {
                console.log('Error checking for orders:', error);
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(checkForNewOrders, 30000);
        console.log('ðŸ”„ Auto-refresh enabled (30s interval)');
    </script>
</div>
</body>
</html>
