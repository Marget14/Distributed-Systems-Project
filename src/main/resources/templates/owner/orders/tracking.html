<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
  <title>Track Order - StreetFoodGo</title>
  <style>
    .tracking-step {
      @apply flex items-center;
    }
    .tracking-step.active .step-icon {
      @apply bg-cyber-blue text-white border-cyber-blue;
    }
    .tracking-step.active .step-label {
      @apply text-cyber-blue font-semibold;
    }
    .tracking-step.completed .step-icon {
      @apply bg-green-500 text-white border-green-500;
    }
    .tracking-step.completed .step-label {
      @apply text-green-400;
    }
    .tracking-step.pending .step-icon {
      @apply bg-white/10 text-gray-400 border-white/10;
    }
    .tracking-step.pending .step-label {
      @apply text-gray-400;
    }
    .step-connector {
      @apply flex-1 h-1 mx-4;
    }
    .step-connector.active {
      @apply bg-cyber-blue;
    }
    .step-connector.completed {
      @apply bg-green-500;
    }
    .step-connector.pending {
      @apply bg-white/10;
    }
  </style>
</head>
<body>
<div layout:fragment="main" class="container mx-auto px-4 py-8">

  <div class="mb-6">
    <a th:href="@{/owner/orders}" class="text-cyber-blue hover:text-cyber-blue/80 flex items-center gap-2">
      <i class="fas fa-arrow-left"></i>Back to Orders
    </a>
  </div>

  <!-- Order Tracking Header -->
  <div class="glass-panel p-8 mb-8">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
      <div>
        <h1 class="text-3xl font-orbitron font-bold text-white mb-2">Order Tracking</h1>
        <div class="flex items-center gap-4">
          <p class="text-gray-400">Order #<span th:text="${order.id}" class="font-mono text-white">00042</span></p>

          <div th:with="statusStr=${#strings.toString(order.status)}">
            <span th:if="${statusStr == 'PENDING'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-yellow-500/20 text-yellow-300" th:text="${order.status}">PENDING</span>
            <span th:if="${statusStr == 'PREPARING'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-blue-500/20 text-blue-300" th:text="${order.status}">PREPARING</span>
            <span th:if="${statusStr == 'READY'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-purple-500/20 text-purple-300" th:text="${order.status}">READY</span>
            <span th:if="${statusStr == 'DELIVERING'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-cyan-500/20 text-cyan-300" th:text="${order.status}">DELIVERING</span>
            <span th:if="${statusStr == 'COMPLETED'}" class="px-3 py-1 rounded-full text-sm font-semibold bg-green-500/20 text-green-300" th:text="${order.status}">COMPLETED</span>
            <span th:if="${statusStr != 'PENDING' and statusStr != 'PREPARING' and statusStr != 'READY' and statusStr != 'DELIVERING' and statusStr != 'COMPLETED'}"
                  class="px-3 py-1 rounded-full text-sm font-semibold bg-red-500/20 text-red-300" th:text="${order.status}">OTHER</span>
          </div>
        </div>
        <p class="text-gray-400 mt-2">Store: <span class="text-white" th:text="${order.store?.name}">Store</span></p>
      </div>
      <div class="mt-4 md:mt-0" th:if="${order.estimatedDeliveryMinutes != null}">
        <p class="text-gray-400">Estimated Delivery</p>
        <p class="text-2xl font-bold text-cyber-blue" th:text="${order.estimatedDeliveryMinutes} + ' min'">0 min</p>
      </div>
    </div>
  </div>

  <!-- Tracking Progress (simplified, based on real timestamps) -->
  <div class="glass-panel p-8 mb-8">
    <div class="max-w-4xl mx-auto">

      <!-- Live Map -->
      <div th:if="${order.orderType?.name() == 'DELIVERY' && order.deliveryAddress != null}" class="mb-8">
        <h3 class="text-xl font-bold text-white mb-4">Delivery Route</h3>
        <div class="glass-panel p-4">
          <div id="ownerTrackingMap" class="w-full h-80 rounded-lg overflow-hidden bg-gray-900"></div>
          <div class="mt-4 flex justify-between text-sm text-gray-400">
            <div>
              <i class="fas fa-store text-neon-pink mr-1"></i>
              <span th:text="${order.store?.name}">Store</span>
            </div>
            <div>
              <i class="fas fa-home text-cyber-blue mr-1"></i>
              <span>Customer</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery Details -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="glass-panel p-6">
          <h4 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-store mr-2"></i>Store Information
          </h4>
          <div class="space-y-2">
            <p class="text-white" th:text="${order.store.name}">Store</p>
            <p class="text-gray-400 text-sm" th:if="${order.store.address != null}" th:text="${order.store.address}">Address</p>
          </div>
        </div>

        <div class="glass-panel p-6" th:if="${order.deliveryAddress != null}">
          <h4 class="text-lg font-bold text-white mb-4">
            <i class="fas fa-home mr-2"></i>Delivery Address
          </h4>
          <div class="space-y-2">
            <p class="text-white" th:text="${order.deliveryAddress.street} + ' ' + ${order.deliveryAddress.number != null ? order.deliveryAddress.number : ''}">Street</p>
            <p class="text-gray-400 text-sm" th:if="${order.deliveryAddress.area != null}" th:text="${order.deliveryAddress.area}">Area</p>
          </div>
        </div>
      </div>

    </div>
  </div>

</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script th:inline="javascript">
  const orderType = /*[[${order.orderType.name}]]*/ 'DELIVERY';
  const orderStatus = /*[[${order.status.name}]]*/ 'PENDING';

  document.addEventListener('DOMContentLoaded', function() {
    if (orderType !== 'DELIVERY') return;

    const mapElement = document.getElementById('ownerTrackingMap');
    if (!mapElement) return;

    const storeCoords = /*[[${order.store.latitude != null && order.store.longitude != null
                            ? #lists.toList(order.store.latitude, order.store.longitude)
                            : #lists.toList(37.9838, 23.7275)}]]*/ [37.9838, 23.7275];

    const customerCoords = /*[[${order.deliveryAddress != null && order.deliveryAddress.latitude != null && order.deliveryAddress.longitude != null
                               ? #lists.toList(order.deliveryAddress.latitude, order.deliveryAddress.longitude)
                               : #lists.toList(37.9838, 23.7275)}]]*/ [37.9838, 23.7275];

    const storeName = /*[[${order.store.name}]]*/ 'Store';

    const map = L.map('ownerTrackingMap', {
      zoomControl: true,
      scrollWheelZoom: true
    }).setView(storeCoords, 13);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
      maxZoom: 19
    }).addTo(map);

    const storeIcon = L.divIcon({
      className: '',
      html: '<div style="background:#f093fb;border:3px solid #fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 8px rgba(0,0,0,0.3);">üè™</div>',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    const customerIcon = L.divIcon({
      className: '',
      html: '<div style="background:#4facfe;border:3px solid #fff;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;font-size:16px;box-shadow:0 4px 8px rgba(0,0,0,0.3);">üè†</div>',
      iconSize: [30, 30],
      iconAnchor: [15, 15]
    });

    L.marker(storeCoords, { icon: storeIcon }).addTo(map).bindPopup(`<strong>üè™ ${storeName}</strong>`);
    L.marker(customerCoords, { icon: customerIcon }).addTo(map).bindPopup('<strong>üè† Customer</strong>');

    // üõµ LIVE DRIVER MARKER
    const driverIcon = L.divIcon({
        className: 'driver-marker',
        html: '<div style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transform: scaleX(-1);">üõµ</div>',
        iconSize: [32, 32],
        iconAnchor: [16, 16]
    });

    // Always show driver at store initially (or last known location if we had one)
    const driverMarker = L.marker(storeCoords, { icon: driverIcon, zIndexOffset: 1000 }).addTo(map);

    const proxyUrl = `/api/v1/routing/route?fromLat=${storeCoords[0]}&fromLon=${storeCoords[1]}&toLat=${customerCoords[0]}&toLon=${customerCoords[1]}`;

    fetch(proxyUrl)
      .then(r => {
        if (!r.ok) throw new Error(`Proxy responded with ${r.status}`);
        return r.json();
      })
      .then(data => {
        const coords = data?.geometry?.coordinates;
        if (data?.geometry?.type === 'LineString' && Array.isArray(coords) && coords.length > 1) {
          const latLngs = coords.map(c => [c[1], c[0]]);

          const routeLine = L.polyline(latLngs, {
            color: '#4facfe',
            weight: 5,
            opacity: 0.8,
            dashArray: '10, 15',
            dashOffset: '0',
            lineCap: 'round'
          }).addTo(map);

          let offset = 0;
          setInterval(() => {
            offset = (offset - 1) % 25;
            routeLine.setStyle({ dashOffset: offset });
          }, 50);

          map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

          // Animate driver along the path if status is DELIVERING
          let step = 0;
          const totalSteps = 2000;

          if (orderStatus === 'DELIVERING') {
              console.log('üöÄ Starting live driver animation...');
              const animationInterval = setInterval(() => {
                  step = (step + 1) % totalSteps;

                  const progress = step / totalSteps;
                  const distanceOnPath = progress * (latLngs.length - 1);
                  const index = Math.floor(distanceOnPath);
                  const nextIndex = Math.min(index + 1, latLngs.length - 1);
                  const segmentProgress = distanceOnPath - index;

                  const p1 = latLngs[index];
                  const p2 = latLngs[nextIndex];

                  if (p1 && p2) {
                      const lat = p1[0] + (p2[0] - p1[0]) * segmentProgress;
                      const lng = p1[1] + (p2[1] - p1[1]) * segmentProgress;
                      driverMarker.setLatLng([lat, lng]);
                  }
              }, 20); // 50fps
          }

        } else {
          L.polyline([storeCoords, customerCoords], {
            color: '#f093fb',
            weight: 3,
            opacity: 0.5,
            dashArray: '5, 10'
          }).addTo(map);

          const bounds = L.latLngBounds([storeCoords, customerCoords]);
          map.fitBounds(bounds, { padding: [50, 50] });
        }
      })
      .catch(error => {
        console.error('Routing proxy error:', error);
        L.polyline([storeCoords, customerCoords], {
          color: '#f093fb',
          weight: 3,
          opacity: 0.5,
          dashArray: '5, 10'
        }).addTo(map);

        const bounds = L.latLngBounds([storeCoords, customerCoords]);
        map.fitBounds(bounds, { padding: [50, 50] });
      });
  });
</script>
</body>
</html>

