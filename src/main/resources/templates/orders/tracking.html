<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head><title>Order Tracking</title></head>
<body>
<div layout:fragment="main" class="container mx-auto px-4 py-8">
    <div class="mb-6">
        <a th:href="@{/orders/{id}(id=${order.id()})}" class="text-cyber-blue hover:text-cyber-blue/80 flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>Back to Order
        </a>
    </div>

    <div class="glass-panel p-8">
        <div class="flex justify-between items-start mb-6">
            <div>
                <h1 class="text-3xl font-orbitron font-bold text-white mb-2">
                    Tracking Order #<span th:text="${order.id}">1</span>
                </h1>
                <p class="text-gray-400">
                    Store: <span class="text-white" th:text="${order.store.name}">Store</span>
                </p>
                <p th:if="${order.estimatedDeliveryMinutes != null}" class="text-gray-400">
                    Estimated delivery: <span class="text-white" th:text="${order.estimatedDeliveryMinutes} + ' min'"></span>
                    <span th:if="${order.estimatedDeliveryDistanceKm != null}" class="text-gray-500">(
                        <span th:text="${#numbers.formatDecimal(order.estimatedDeliveryDistanceKm, 1, 2)}"></span> km
                    )</span>
                </p>
            </div>
            <span class="px-4 py-2 rounded-full text-sm font-semibold"
                  th:classappend="${order.status.name() == 'PENDING' ? 'bg-yellow-500/20 text-yellow-300' :
                                   order.status.name() == 'PREPARING' ? 'bg-blue-500/20 text-blue-300' :
                                   order.status.name() == 'READY' ? 'bg-purple-500/20 text-purple-300' :
                                   order.status.name() == 'DELIVERING' ? 'bg-cyan-500/20 text-cyan-300' :
                                   order.status.name() == 'COMPLETED' ? 'bg-green-500/20 text-green-300' :
                                   'bg-red-500/20 text-red-300'}"
                  th:text="${order.status}">STATUS</span>
        </div>

        <!-- Delivery Metrics (shown when order is accepted) -->
        <div th:if="${order.status.name() == 'PREPARING' || order.status.name() == 'READY' || order.status.name() == 'DELIVERING'}"
             class="mb-8 p-6 bg-cyber-blue/10 border border-cyber-blue/30 rounded-lg">
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                <div class="text-center">
                    <p class="text-gray-400 text-sm mb-2">üìç Distance</p>
                    <p class="text-2xl font-bold text-cyber-blue" th:text="${#numbers.formatDecimal(order.estimatedDeliveryDistanceKm, 1, 2)} + ' km'">
                        0.00 km
                    </p>
                </div>
                <div class="text-center">
                    <p class="text-gray-400 text-sm mb-2">‚è±Ô∏è Estimated Time</p>
                    <p class="text-2xl font-bold text-cyber-blue" th:text="${order.estimatedDeliveryMinutes} + ' min'">
                        0 min
                    </p>
                </div>
                <div class="text-center md:col-span-1 col-span-2">
                    <p class="text-gray-400 text-sm mb-2">üè™ Status</p>
                    <p class="text-lg font-semibold text-white" th:text="${order.status}">PREPARING</p>
                </div>
            </div>
        </div>

        <!-- üó∫Ô∏è LIVE MAP WITH ROUTE -->
        <div th:if="${order.orderType.name() == 'DELIVERY' && order.deliveryAddress != null}"
             class="mb-8">
            <h3 class="text-xl font-bold text-white mb-4">
                <i class="fas fa-map-marked-alt mr-2"></i>Delivery Route
            </h3>
            <div class="glass-panel p-4">
                <div id="deliveryMap" class="w-full h-96 rounded-lg overflow-hidden bg-gray-900"></div>
                <div class="mt-4 flex justify-between text-sm text-gray-400">
                    <div>
                        <i class="fas fa-store text-neon-pink mr-1"></i>
                        <span th:text="${order.store.name}">Store</span>
                    </div>
                    <div>
                        <i class="fas fa-home text-cyber-blue mr-1"></i>
                        <span>Your Address</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="space-y-4">
            <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center">
                    <i class="fas fa-check text-white"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-white font-semibold">Order placed</h3>
                    <p class="text-gray-400 text-sm" th:text="${#temporals.format(order.createdAt, 'dd/MM/yyyy HH:mm')}">date</p>
                </div>
            </div>

            <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                     th:classappend="${order.acceptedAt != null ? 'bg-blue-500' : 'bg-white/10'}">
                    <i class="fas fa-utensils text-white"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-white font-semibold">Accepted / preparing</h3>
                    <p class="text-gray-400 text-sm" th:if="${order.acceptedAt != null}" th:text="${#temporals.format(order.acceptedAt, 'dd/MM/yyyy HH:mm')}">date</p>
                    <p class="text-gray-500 text-sm" th:if="${order.acceptedAt == null}">Waiting for store to accept</p>
                </div>
            </div>

            <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                     th:classappend="${order.readyAt != null ? 'bg-purple-500' : 'bg-white/10'}">
                    <i class="fas fa-box text-white"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-white font-semibold" th:text="${order.orderType.name() == 'PICKUP' ? 'Ready for pickup' : 'Ready for delivery'}">Ready</h3>
                    <p class="text-gray-400 text-sm" th:if="${order.readyAt != null}" th:text="${#temporals.format(order.readyAt, 'dd/MM/yyyy HH:mm')}">date</p>
                    <p class="text-gray-500 text-sm" th:if="${order.readyAt == null}">Not ready yet</p>
                </div>
            </div>

            <div th:if="${order.orderType.name() == 'DELIVERY'}" class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                     th:classappend="${order.deliveringAt != null ? 'bg-cyan-500' : 'bg-white/10'}">
                    <i class="fas fa-truck text-white"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-white font-semibold">Out for delivery</h3>
                    <p class="text-gray-400 text-sm" th:if="${order.deliveringAt != null}" th:text="${#temporals.format(order.deliveringAt, 'dd/MM/yyyy HH:mm')}">date</p>
                    <p class="text-gray-500 text-sm" th:if="${order.deliveringAt == null}">Not out yet</p>
                </div>
            </div>

            <div class="flex items-start gap-4">
                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                     th:classappend="${order.completedAt != null ? 'bg-green-500' : 'bg-white/10'}">
                    <i class="fas fa-flag-checkered text-white"></i>
                </div>
                <div class="flex-1">
                    <h3 class="text-white font-semibold">Completed</h3>
                    <p class="text-gray-400 text-sm" th:if="${order.completedAt != null}" th:text="${#temporals.format(order.completedAt, 'dd/MM/yyyy HH:mm')}">date</p>
                    <p class="text-gray-500 text-sm" th:if="${order.completedAt == null}">Not completed yet</p>
                </div>
            </div>

            <div th:if="${order.status.name() == 'REJECTED'}" class="mt-6 bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                <p class="text-red-300 font-semibold">Rejected</p>
                <p class="text-gray-300 text-sm" th:text="${order.rejectionReason}">Reason</p>
            </div>
            <div th:if="${order.status.name() == 'CANCELLED'}" class="mt-6 bg-red-500/10 border border-red-500/30 rounded-lg p-4">
                <p class="text-red-300 font-semibold">Cancelled</p>
                <p class="text-gray-300 text-sm">This order was cancelled.</p>
            </div>
        </div>

        <div class="mt-8 flex gap-3">
            <a th:href="@{/orders/{id}(id=${order.id})}" class="cyber-button inline-block opacity-60 hover:opacity-80">View details</a>
            <a th:href="@{/orders}" class="cyber-button inline-block opacity-60 hover:opacity-80">My orders</a>
        </div>
    </div>
</div>


<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script th:inline="javascript">
    // Auto-refresh tracking page every 10 seconds while order is not completed
    const orderStatus = /*[[${order.status.name}]]*/ 'PENDING';
    const orderType = /*[[${order.orderType.name}]]*/ 'DELIVERY';

    console.log('üçï Order Status:', orderStatus, '| Type:', orderType);

    if (orderStatus && !['COMPLETED', 'REJECTED', 'CANCELLED'].includes(orderStatus)) {
        console.log('‚è∞ Auto-refresh enabled - will refresh in 10s');
        setTimeout(function() {
            location.reload();
        }, 10000);
    }

    // üó∫Ô∏è Initialize Delivery Map
    if (orderType === 'DELIVERY') {
        document.addEventListener('DOMContentLoaded', function() {
            const mapElement = document.getElementById('deliveryMap');
            if (!mapElement) {
                console.log('‚ö†Ô∏è Map element not found');
                return;
            }

            // Get coordinates from Thymeleaf
            const storeCoords = /*[[${order.store().latitude() != null && order.store().longitude() != null
                                    ? #lists.toList(order.store().latitude(), order.store().longitude())
                                    : #lists.toList(37.9838, 23.7275)}]]*/ [37.9838, 23.7275];

            const homeCoords = /*[[${order.deliveryAddress() != null && order.deliveryAddress().latitude() != null && order.deliveryAddress().longitude() != null
                                   ? #lists.toList(order.deliveryAddress().latitude(), order.deliveryAddress().longitude())
                                   : #lists.toList(37.9838, 23.7275)}]]*/ [37.9838, 23.7275];

            const storeName = /*[[${order.store().name()}]]*/ 'Store';
            const deliveryAddress = /*[[${order.deliveryAddress() != null ? order.deliveryAddress().street() : 'Home'}]]*/ 'Home';

            // Initialize map
            const map = L.map('deliveryMap', {
                zoomControl: true,
                scrollWheelZoom: true
            }).setView(storeCoords, 13);

            // Add dark themed tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                maxZoom: 19
            }).addTo(map);

            // Custom icon for store (pink)
            const storeIcon = L.divIcon({
                className: 'delivery-marker-store',
                html: 'üè™',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // Custom icon for home (blue)
            const homeIcon = L.divIcon({
                className: 'delivery-marker-home',
                html: 'üè†',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            });

            // Add markers
            L.marker(storeCoords, { icon: storeIcon })
                .addTo(map)
                .bindPopup(`<strong>üè™ ${storeName}</strong><br>Preparing your order...`);

            L.marker(homeCoords, { icon: homeIcon })
                .addTo(map)
                .bindPopup(`<strong>üè† Delivery Address</strong><br>${deliveryAddress}`);

            // üõµ LIVE DRIVER MARKER
            // Create motorcycle icon
            const driverIcon = L.divIcon({
                className: 'driver-marker',
                html: '<div style="font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transform: scaleX(-1);">üõµ</div>',
                iconSize: [32, 32],
                iconAnchor: [16, 16]
            });

            // Always show driver at store initially
            const driverMarker = L.marker(storeCoords, { icon: driverIcon, zIndexOffset: 1000 }).addTo(map);

            // Call backend proxy instead of hitting OSRM directly from the browser.
            const proxyUrl = `/api/v1/routing/route?fromLat=${storeCoords[0]}&fromLon=${storeCoords[1]}&toLat=${homeCoords[0]}&toLon=${homeCoords[1]}`;

            fetch(proxyUrl)
                .then(r => {
                    if (!r.ok) throw new Error(`Proxy responded with ${r.status}`);
                    return r.json();
                })
                .then(data => {
                    const coords = data?.geometry?.coordinates;
                    if (data?.geometry?.type === 'LineString' && Array.isArray(coords) && coords.length > 1) {
                        // GeoJSON returns [lon, lat], Leaflet needs [lat, lon]
                        const latLngs = coords.map(c => [c[1], c[0]]);

                        const routeLine = L.polyline(latLngs, {
                            color: '#4facfe',
                            weight: 5,
                            opacity: 0.8,
                            dashArray: '10, 15',
                            dashOffset: '0',
                            lineCap: 'round'
                        }).addTo(map);

                        // Animate dash
                        let offset = 0;
                        setInterval(() => {
                            offset = (offset - 1) % 25;
                            routeLine.setStyle({ dashOffset: offset });
                        }, 50);

                        map.fitBounds(routeLine.getBounds(), { padding: [50, 50] });

                        // Animate driver along the path
                        let step = 0;
                        const totalSteps = 2000; // Slower, smoother animation (2000 steps)

                        // Animate if DELIVERING (or for demo purposes if requested)
                        if (orderStatus === 'DELIVERING') {
                            console.log('üöÄ Starting live driver animation...');

                            const animationInterval = setInterval(() => {
                                step = (step + 1) % totalSteps;

                                // Calculate position
                                const progress = step / totalSteps;
                                const distanceOnPath = progress * (latLngs.length - 1);
                                const index = Math.floor(distanceOnPath);
                                const nextIndex = Math.min(index + 1, latLngs.length - 1);
                                const segmentProgress = distanceOnPath - index;

                                const p1 = latLngs[index];
                                const p2 = latLngs[nextIndex];

                                if (p1 && p2) {
                                    // Linear interpolation
                                    const lat = p1[0] + (p2[0] - p1[0]) * segmentProgress;
                                    const lng = p1[1] + (p2[1] - p1[1]) * segmentProgress;
                                    driverMarker.setLatLng([lat, lng]);
                                }
                            }, 20); // 50fps
                        }

                        const midpoint = latLngs[Math.floor(latLngs.length / 2)];
                        L.circle(midpoint, {
                            radius: 50,
                            color: '#4facfe',
                            fillColor: '#4facfe',
                            fillOpacity: 0.3
                        }).addTo(map).bindPopup(`
                            <strong>üìç Delivery Route</strong><br>
                            Distance: ${(data.distanceKm ?? 0).toFixed(2)} km<br>
                            ETA: ${Math.ceil(data.durationMinutes ?? 0)} minutes
                            ${data.fallback ? '<br><small>(approx.)</small>' : ''}
                        `);
                    } else {
                        // Fallback: draw straight line
                        L.polyline([storeCoords, homeCoords], {
                            color: '#4facfe',
                            weight: 3,
                            opacity: 0.5,
                            dashArray: '5, 10'
                        }).addTo(map);

                        const bounds = L.latLngBounds([storeCoords, homeCoords]);
                        map.fitBounds(bounds, { padding: [50, 50] });
                    }
                })
                .catch(error => {
                    console.error('Routing proxy error:', error);
                    L.polyline([storeCoords, homeCoords], {
                        color: '#f093fb',
                        weight: 3,
                        opacity: 0.5,
                        dashArray: '5, 10'
                    }).addTo(map);

                    const bounds = L.latLngBounds([storeCoords, homeCoords]);
                    map.fitBounds(bounds, { padding: [50, 50] });
                });
        });
    }


</body>
</html>
