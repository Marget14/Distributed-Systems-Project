<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>My Addresses - StreetFoodGo</title>
</head>
<body>
<div layout:fragment="main">
    <!-- Header -->
    <div class="glass-panel p-8 mb-8">
        <h1 class="text-3xl font-orbitron font-bold text-white mb-2">My Addresses</h1>
        <p class="text-gray-400">Manage your delivery addresses</p>
    </div>

    <!-- Addresses List -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-white">Saved Addresses</h2>
            <button onclick="openAddressModal()" class="cyber-button">
                <i class="fas fa-plus mr-2"></i>Add New Address
            </button>
        </div>

        <div th:if="${#lists.isEmpty(addresses)}" class="glass-panel p-12 text-center">
            <i class="fas fa-map-marker-alt text-4xl text-gray-500 mb-4"></i>
            <h3 class="text-xl font-bold text-white mb-2">No addresses saved</h3>
            <p class="text-gray-400 mb-6">Add your first address to start ordering</p>
            <button onclick="openAddressModal()" class="cyber-button">
                <i class="fas fa-plus mr-2"></i>Add Your First Address
            </button>
        </div>

        <div th:unless="${#lists.isEmpty(addresses)}" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div th:each="address : ${addresses}" class="glass-panel p-6 hover-lift">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h3 class="text-lg font-bold text-white" th:text="${address.label}"></h3>
                        <span th:if="${address.isDefault}"
                              class="px-2 py-1 bg-cyber-blue/20 text-cyber-blue rounded text-xs font-semibold">
                            Default
                        </span>
                    </div>
                    <div class="flex gap-2">
                        <button th:onclick="'editAddress(' + ${address.id} + ')'"
                                class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20">
                            <i class="fas fa-edit text-sm"></i>
                        </button>
                        <button th:onclick="'deleteAddress(' + ${address.id} + ')'"
                                class="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center hover:bg-red-500/30">
                            <i class="fas fa-trash text-sm text-red-400"></i>
                        </button>
                    </div>
                </div>

                <div class="space-y-3 text-gray-300">
                    <p class="flex items-center">
                        <i class="fas fa-user w-5 mr-3"></i>
                        <span th:text="${address.recipientName}"></span>
                    </p>
                    <p class="flex items-center">
                        <i class="fas fa-map-marker-alt w-5 mr-3"></i>
                        <span th:text="${address.streetAddress}"></span>
                    </p>
                    <p class="flex items-center">
                        <i class="fas fa-city w-5 mr-3"></i>
                        <span th:text="${address.city} + ', ' + ${address.postalCode}"></span>
                    </p>
                    <p class="flex items-center">
                        <i class="fas fa-location-arrow w-5 mr-3"></i>
                        <span th:text="${address.area}"></span>
                    </p>
                    <p th:if="${address.instructions}" class="flex items-start">
                        <i class="fas fa-sticky-note w-5 mr-3 mt-1"></i>
                        <span class="text-gray-400" th:text="${address.instructions}"></span>
                    </p>
                </div>

                <div class="mt-6 pt-6 border-t border-white/10 flex justify-between">
                    <button th:onclick="'setAsDefault(' + ${address.id} + ')'"
                            th:disabled="${address.isDefault}"
                            th:class="${address.isDefault ?
                                'px-4 py-2 bg-white/5 text-gray-500 rounded-lg text-sm cursor-not-allowed' :
                                'px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg text-sm'}"
                            th:text="${address.isDefault ? 'Current Default' : 'Set as Default'}">
                    </button>
                    <button th:onclick="'useForOrder(' + ${address.id} + ')'"
                            class="px-4 py-2 bg-cyber-blue/20 hover:bg-cyber-blue/30 text-cyber-blue rounded-lg text-sm">
                        Use for Order
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Address Modal -->
<div id="addressModal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
    <div class="glass-panel p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-white" id="modalTitle">Add New Address</h3>
            <button onclick="closeAddressModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <form id="addressForm" class="space-y-6">
            <input type="hidden" id="addressId" name="id">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Label *</label>
                    <input type="text" id="label" name="label" required
                           class="quantum-input w-full"
                           placeholder="Home, Work, etc.">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Recipient Name *</label>
                    <input type="text" id="recipientName" name="recipientName" required
                           class="quantum-input w-full"
                           placeholder="Full Name">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Street Address *</label>
                <input type="text" id="streetAddress" name="streetAddress" required
                       class="quantum-input w-full"
                       placeholder="Street name and number">
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">City *</label>
                    <input type="text" id="city" name="city" required
                           class="quantum-input w-full"
                           placeholder="Athens">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Postal Code *</label>
                    <input type="text" id="postalCode" name="postalCode" required
                           class="quantum-input w-full"
                           placeholder="10431">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">Area *</label>
                    <input type="text" id="area" name="area" required
                           class="quantum-input w-full"
                           placeholder="Kolonaki, Syntagma, etc.">
                </div>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-300 mb-2">Additional Instructions</label>
                <textarea id="instructions" name="instructions"
                          class="quantum-input w-full"
                          rows="3"
                          placeholder="e.g., Ring bell, Leave at door, Call before arrival"></textarea>
            </div>

            <div class="flex items-center">
                <input type="checkbox" id="isDefault" name="isDefault"
                       class="w-4 h-4 rounded bg-white/5 border-white/10 text-cyber-blue focus:ring-cyber-blue">
                <label for="isDefault" class="ml-3 text-gray-300">Set as default delivery address</label>
            </div>

            <div class="flex justify-end gap-4 pt-6">
                <button type="button" onclick="closeAddressModal()"
                        class="px-6 py-3 bg-white/10 hover:bg-white/20 text-white rounded-lg">
                    Cancel
                </button>
                <button type="submit" class="cyber-button">
                    Save Address
                </button>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript for Address Management -->
<script>
    let currentEditingAddressId = null;

    function openAddressModal(addressId = null) {
        const modal = document.getElementById('addressModal');
        const title = document.getElementById('modalTitle');
        const form = document.getElementById('addressForm');

        if (addressId) {
            // Load existing address
            title.textContent = 'Edit Address';
            currentEditingAddressId = addressId;
            // Fetch address details and populate form
            fetch(`/api/addresses/${addressId}`)
                .then(response => response.json())
                .then(address => {
                    document.getElementById('addressId').value = address.id;
                    document.getElementById('label').value = address.label;
                    document.getElementById('recipientName').value = address.recipientName;
                    document.getElementById('streetAddress').value = address.streetAddress;
                    document.getElementById('city').value = address.city;
                    document.getElementById('postalCode').value = address.postalCode;
                    document.getElementById('area').value = address.area;
                    document.getElementById('instructions').value = address.instructions || '';
                    document.getElementById('isDefault').checked = address.isDefault;
                });
        } else {
            // New address
            title.textContent = 'Add New Address';
            currentEditingAddressId = null;
            form.reset();
            document.getElementById('addressId').value = '';
        }

        modal.classList.remove('hidden');
    }

    function closeAddressModal() {
        document.getElementById('addressModal').classList.add('hidden');
        document.getElementById('addressForm').reset();
        currentEditingAddressId = null;
    }

    // Handle form submission
    document.getElementById('addressForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = {
            label: document.getElementById('label').value,
            recipientName: document.getElementById('recipientName').value,
            streetAddress: document.getElementById('streetAddress').value,
            city: document.getElementById('city').value,
            postalCode: document.getElementById('postalCode').value,
            area: document.getElementById('area').value,
            instructions: document.getElementById('instructions').value,
            isDefault: document.getElementById('isDefault').checked
        };

        const url = currentEditingAddressId ?
            `/api/addresses/${currentEditingAddressId}` :
            '/api/addresses';
        const method = currentEditingAddressId ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            },
            body: JSON.stringify(formData)
        })
            .then(response => {
                if (response.ok) {
                    closeAddressModal();
                    location.reload();
                }
            });
    });

    function editAddress(addressId) {
        openAddressModal(addressId);
    }

    function deleteAddress(addressId) {
        if (confirm('Are you sure you want to delete this address?')) {
            fetch(`/api/addresses/${addressId}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
                }
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                });
        }
    }

    function setAsDefault(addressId) {
        fetch(`/api/addresses/${addressId}/default`, {
            method: 'PUT',
            headers: {
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            }
        })
            .then(response => {
                if (response.ok) {
                    location.reload();
                }
            });
    }

    function useForOrder(addressId) {
        // Set this address as the delivery address for the current cart
        fetch('/api/cart/delivery-address', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN': document.querySelector('meta[name="_csrf"]').getAttribute('content')
            },
            body: JSON.stringify({ addressId: addressId })
        })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/cart';
                }
            });
    }

    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeAddressModal();
        }
    });

    // Close modal when clicking outside
    document.getElementById('addressModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeAddressModal();
        }
    });
</script>
</body>
</html>