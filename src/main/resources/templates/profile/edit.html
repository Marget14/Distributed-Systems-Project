<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Edit Profile - StreetFoodGo</title>
</head>
<body>
<div layout:fragment="main">
    <!-- Header -->
    <div class="glass-panel p-8 mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-orbitron font-bold text-white mb-2">Edit Profile</h1>
                <p class="text-gray-400">Update your personal information and preferences</p>
            </div>
            <a th:href="@{/profile}" class="px-4 py-2 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                <i class="fas fa-arrow-left mr-2"></i>Back to Profile
            </a>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <!-- Success Message -->
        <div th:if="${success}" class="glass-panel p-4 mb-8 bg-green-500/20 border border-green-500/50">
            <p class="text-green-400" th:text="${success}"></p>
        </div>

        <!-- Tabs -->
        <div class="flex space-x-2 mb-8 overflow-x-auto">
            <button class="profile-tab active" data-tab="personal">
                <i class="fas fa-user mr-2"></i>Personal Info
            </button>
            <button class="profile-tab" data-tab="security">
                <i class="fas fa-lock mr-2"></i>Security
            </button>
            <button class="profile-tab" data-tab="preferences">
                <i class="fas fa-cog mr-2"></i>Preferences
            </button>
            <button class="profile-tab" data-tab="notifications">
                <i class="fas fa-bell mr-2"></i>Notifications
            </button>
        </div>

        <!-- Personal Info Tab (Default) -->
        <div id="personalTab" class="tab-content">
            <div class="glass-panel p-8">
                <form th:action="@{/profile/update}" method="post" th:object="${user}" class="space-y-6">
                    <!-- Avatar Upload -->
                    <div class="flex items-center mb-8">
                        <div class="relative mr-6">
                            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-cyber-blue to-quantum flex items-center justify-center">
                                <i class="fas fa-user text-white text-3xl"></i>
                            </div>
                            <button type="button" class="absolute bottom-0 right-0 w-10 h-10 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center">
                                <i class="fas fa-camera text-white"></i>
                            </button>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold text-white mb-2">Profile Photo</h3>
                            <p class="text-gray-400 text-sm">JPG, GIF or PNG. Max size 2MB</p>
                        </div>
                    </div>

                    <!-- Name -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">First Name *</label>
                            <input type="text" th:field="*{firstName}" required
                                   class="quantum-input w-full">
                            <div class="text-red-400 text-sm mt-1" th:if="${#fields.hasErrors('firstName')}" th:errors="*{firstName}"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Last Name *</label>
                            <input type="text" th:field="*{lastName}" required
                                   class="quantum-input w-full">
                            <div class="text-red-400 text-sm mt-1" th:if="${#fields.hasErrors('lastName')}" th:errors="*{lastName}"></div>
                        </div>
                    </div>

                    <!-- Contact Info -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Email Address *</label>
                            <input type="email" th:field="*{emailAddress}" readonly
                                   class="quantum-input w-full bg-white/5 cursor-not-allowed"
                                   placeholder="your@email.com">
                            <p class="text-gray-400 text-xs mt-1">Email cannot be changed</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">Phone Number *</label>
                            <input type="tel" th:field="*{mobilePhoneNumber}" required
                                   class="quantum-input w-full"
                                   placeholder="+30 69X XXX XXXX">
                            <div class="text-red-400 text-sm mt-1" th:if="${#fields.hasErrors('mobilePhoneNumber')}" th:errors="*{mobilePhoneNumber}"></div>
                        </div>
                    </div>

                    <!-- Date of Birth -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Date of Birth</label>
                        <div class="grid grid-cols-3 gap-4">
                            <select th:field="*{birthDay}" class="quantum-input">
                                <option value="">Day</option>
                                <option th:each="day : ${#numbers.sequence(1,31)}"
                                        th:value="${day}"
                                        th:text="${day}"></option>
                            </select>
                            <select th:field="*{birthMonth}" class="quantum-input">
                                <option value="">Month</option>
                                <option value="1">January</option>
                                <option value="2">February</option>
                                <option value="3">March</option>
                                <option value="4">April</option>
                                <option value="5">May</option>
                                <option value="6">June</option>
                                <option value="7">July</option>
                                <option value="8">August</option>
                                <option value="9">September</option>
                                <option value="10">October</option>
                                <option value="11">November</option>
                                <option value="12">December</option>
                            </select>
                            <select th:field="*{birthYear}" class="quantum-input">
                                <option value="">Year</option>
                                <option th:each="year : ${#numbers.sequence(2006, 1950)}"
                                        th:value="${year}"
                                        th:text="${year}"></option>
                            </select>
                        </div>
                    </div>

                    <!-- Gender -->
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Gender</label>
                        <div class="flex space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" th:field="*{gender}" value="MALE" class="mr-2">
                                <span class="text-gray-300">Male</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" th:field="*{gender}" value="FEMALE" class="mr-2">
                                <span class="text-gray-300">Female</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" th:field="*{gender}" value="OTHER" class="mr-2">
                                <span class="text-gray-300">Other</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" th:field="*{gender}" value="PREFER_NOT_TO_SAY" class="mr-2">
                                <span class="text-gray-300">Prefer not to say</span>
                            </label>
                        </div>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="flex justify-end space-x-4 pt-6 border-t border-white/10">
                        <a th:href="@{/profile}" class="px-6 py-3 bg-white/10 hover:bg-white/20 rounded-lg text-white">
                            Cancel
                        </a>
                        <button type="submit" class="cyber-button">
                            <i class="fas fa-save mr-2"></i>Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Security Tab -->
        <div id="securityTab" class="tab-content hidden">
            <div class="glass-panel p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Security Settings</h3>

                <!-- Change Password -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Change Password</h4>
                    <form id="changePasswordForm" class="space-y-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-2">Current Password</label>
                            <input type="password" id="currentPassword" required
                                   class="quantum-input w-full">
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-300 mb-2">New Password</label>
                                <input type="password" id="newPassword" required
                                       class="quantum-input w-full">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-300 mb-2">Confirm New Password</label>
                                <input type="password" id="confirmPassword" required
                                       class="quantum-input w-full">
                            </div>
                        </div>

                        <div id="passwordMessage" class="hidden p-3 rounded-lg"></div>

                        <div class="flex justify-end">
                            <button type="submit" class="cyber-button">
                                Update Password
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Two-Factor Authentication -->
                <div class="border-t border-white/10 pt-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Two-Factor Authentication</h4>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-white">Two-factor authentication is <span class="text-red-400">disabled</span></p>
                            <p class="text-gray-400 text-sm">Add an extra layer of security to your account</p>
                        </div>
                        <button class="px-4 py-2 bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500/30">
                            Enable 2FA
                        </button>
                    </div>
                </div>

                <!-- Active Sessions -->
                <div class="border-t border-white/10 pt-8 mt-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Active Sessions</h4>
                    <div class="space-y-3">
                        <div class="flex items-center justify-between p-4 bg-white/5 rounded-lg">
                            <div class="flex items-center">
                                <i class="fas fa-desktop text-cyber-blue mr-4"></i>
                                <div>
                                    <p class="text-white">Windows 10 • Chrome</p>
                                    <p class="text-gray-400 text-sm">Athens, Greece • Current session</p>
                                </div>
                            </div>
                            <button class="text-gray-400 hover:text-white">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Preferences Tab -->
        <div id="preferencesTab" class="tab-content hidden">
            <div class="glass-panel p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Preferences</h3>

                <!-- Language -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Language</h4>
                    <select class="quantum-input w-full md:w-64">
                        <option value="en">English</option>
                        <option value="el">Greek</option>
                        <option value="es">Spanish</option>
                        <option value="fr">French</option>
                        <option value="de">German</option>
                    </select>
                </div>

                <!-- Currency -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Currency</h4>
                    <select class="quantum-input w-full md:w-64">
                        <option value="EUR">Euro (€)</option>
                        <option value="USD">US Dollar ($)</option>
                        <option value="GBP">British Pound (£)</option>
                    </select>
                </div>

                <!-- Dietary Preferences -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Dietary Preferences</h4>
                    <div class="space-y-3">
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 rounded bg-white/5 border-white/10">
                            <span class="text-gray-300">Vegetarian</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 rounded bg-white/5 border-white/10">
                            <span class="text-gray-300">Vegan</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 rounded bg-white/5 border-white/10">
                            <span class="text-gray-300">Gluten-Free</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 rounded bg-white/5 border-white/10">
                            <span class="text-gray-300">Dairy-Free</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" class="mr-3 rounded bg-white/5 border-white/10">
                            <span class="text-gray-300">Halal</span>
                        </label>
                    </div>
                </div>

                <!-- Preferred Cuisines -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Preferred Cuisines</h4>
                    <div class="flex flex-wrap gap-2">
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Greek</span>
                        <span class="px-3 py-2 bg-cyber-blue/20 text-cyber-blue rounded-lg cursor-pointer">Italian</span>
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Japanese</span>
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Mexican</span>
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Burgers</span>
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Pizza</span>
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Sushi</span>
                        <span class="px-3 py-2 bg-white/10 text-gray-300 rounded-lg cursor-pointer hover:bg-white/20">Asian</span>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button class="cyber-button">
                        Save Preferences
                    </button>
                </div>
            </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notificationsTab" class="tab-content hidden">
            <div class="glass-panel p-8">
                <h3 class="text-2xl font-bold text-white mb-6">Notification Preferences</h3>

                <!-- Email Notifications -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Email Notifications</h4>
                    <div class="space-y-4">
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Order updates</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" checked class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Promotions & discounts</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">New restaurants</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" checked class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Newsletter</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Push Notifications -->
                <div class="mb-8">
                    <h4 class="text-lg font-semibold text-white mb-4">Push Notifications</h4>
                    <div class="space-y-4">
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Order status changes</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" checked class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Delivery updates</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" checked class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Special offers</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- SMS Notifications -->
                <div class="border-t border-white/10 pt-8">
                    <h4 class="text-lg font-semibold text-white mb-4">SMS Notifications</h4>
                    <div class="space-y-4">
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Order confirmations</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                        <label class="flex items-center justify-between">
                            <span class="text-gray-300">Delivery updates</span>
                            <div class="relative inline-block w-12 align-middle select-none">
                                <input type="checkbox" class="toggle-checkbox">
                                <label class="toggle-label block"></label>
                            </div>
                        </label>
                    </div>
                    <p class="text-gray-400 text-sm mt-4">Standard carrier rates may apply</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Edit Profile -->
<script th:inline="javascript">
    // Get CSRF token
    const csrfToken = /*[[${_csrf.token}]]*/ 'default-token';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ 'X-CSRF-TOKEN';

    // Tab switching
    document.querySelectorAll('.profile-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabId = this.dataset.tab;

            // Update active tab
            document.querySelectorAll('.profile-tab').forEach(t => {
                t.classList.remove('active');
            });
            this.classList.add('active');

            // Show selected tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId + 'Tab').classList.remove('hidden');
        });
    });

    // Toggle switch functionality
    document.querySelectorAll('.toggle-checkbox').forEach(checkbox => {
        const label = checkbox.nextElementSibling;

        checkbox.addEventListener('change', function() {
            if (this.checked) {
                label.classList.add('bg-cyber-blue');
                label.classList.remove('bg-gray-300');
            } else {
                label.classList.remove('bg-cyber-blue');
                label.classList.add('bg-gray-300');
            }
        });

        // Initialize
        if (checkbox.checked) {
            label.classList.add('bg-cyber-blue');
            label.classList.remove('bg-gray-300');
        }
    });

    // Change password form
    document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageDiv = document.getElementById('passwordMessage');

        if (newPassword !== confirmPassword) {
            messageDiv.className = 'p-3 rounded-lg bg-red-500/20 text-red-400';
            messageDiv.textContent = 'New passwords do not match';
            messageDiv.classList.remove('hidden');
            return;
        }

        if (newPassword.length < 6) {
            messageDiv.className = 'p-3 rounded-lg bg-red-500/20 text-red-400';
            messageDiv.textContent = 'New password must be at least 6 characters';
            messageDiv.classList.remove('hidden');
            return;
        }

        fetch('/profile/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                [csrfHeader]: csrfToken
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageDiv.className = 'p-3 rounded-lg bg-green-500/20 text-green-400';
                    messageDiv.textContent = data.message || 'Password changed successfully';
                    messageDiv.classList.remove('hidden');
                    this.reset();
                } else {
                    messageDiv.className = 'p-3 rounded-lg bg-red-500/20 text-red-400';
                    messageDiv.textContent = data.error || 'Failed to change password';
                    messageDiv.classList.remove('hidden');
                }
            })
            .catch(error => {
                messageDiv.className = 'p-3 rounded-lg bg-red-500/20 text-red-400';
                messageDiv.textContent = 'An error occurred. Please try again.';
                messageDiv.classList.remove('hidden');
            });
    });

    // Avatar upload
    const avatarButton = document.querySelector('.absolute.bottom-0.right-0');
    if (avatarButton) {
        avatarButton.addEventListener('click', function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    alert('Avatar upload would be implemented here');
                }
            };

            input.click();
        });

        // Save Preferences
        document.querySelector('#preferencesTab button.cyber-button').addEventListener('click', function() {
            const language = document.querySelector('#preferencesTab select').value;
            const currency = document.querySelectorAll('#preferencesTab select')[1].value;

            const dietaryPrefs = [];
            document.querySelectorAll('#preferencesTab input[type="checkbox"]:checked').forEach(cb => {
                const label = cb.parentElement.textContent.trim().toLowerCase().replace(/\s+/g, '-');
                dietaryPrefs.push(label);
            });

            const cuisines = [];
            document.querySelectorAll('#preferencesTab .px-3.py-2').forEach(span => {
                if (span.classList.contains('bg-cyber-blue/20')) {
                    cuisines.push(span.textContent.trim().toLowerCase());
                }
            });

            fetch('/profile/preferences/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    language: language,
                    currency: currency,
                    dietaryPreferences: dietaryPrefs,
                    preferredCuisines: cuisines
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Preferences saved successfully!');
                    }
                });
        });

// Toggle cuisine selection
        document.querySelectorAll('#preferencesTab .px-3.py-2').forEach(span => {
            span.addEventListener('click', function() {
                this.classList.toggle('bg-white/10');
                this.classList.toggle('text-gray-300');
                this.classList.toggle('bg-cyber-blue/20');
                this.classList.toggle('text-cyber-blue');
            });
        });

// Save Notifications (on toggle change)
        document.querySelectorAll('#notificationsTab .toggle-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const notifications = {
                    emailOrderUpdates: document.querySelectorAll('#notificationsTab .toggle-checkbox')[0].checked,
                    emailPromotions: document.querySelectorAll('#notificationsTab .toggle-checkbox')[1].checked,
                    emailNewRestaurants: document.querySelectorAll('#notificationsTab .toggle-checkbox')[2].checked,
                    emailNewsletter: document.querySelectorAll('#notificationsTab .toggle-checkbox')[3].checked,
                    pushOrderStatus: document.querySelectorAll('#notificationsTab .toggle-checkbox')[4].checked,
                    pushDeliveryUpdates: document.querySelectorAll('#notificationsTab .toggle-checkbox')[5].checked,
                    pushSpecialOffers: document.querySelectorAll('#notificationsTab .toggle-checkbox')[6].checked,
                    smsOrderConfirmations: document.querySelectorAll('#notificationsTab .toggle-checkbox')[7].checked,
                    smsDeliveryUpdates: document.querySelectorAll('#notificationsTab .toggle-checkbox')[8].checked
                };

                fetch('/profile/notifications/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        [csrfHeader]: csrfToken
                    },
                    body: JSON.stringify(notifications)
                });
            });
        });
    }
</script>

<style>
    .toggle-checkbox {
        position: absolute;
        display: block;
        width: 1.5rem;
        height: 1.5rem;
        border-radius: 9999px;
        background-color: white;
        border-width: 4px;
        appearance: none;
        cursor: pointer;
        transition: all 0.3s;
    }
    .toggle-checkbox:checked {
        right: 0;
        border-color: #00d4ff;
    }
    .toggle-label {
        display: block;
        overflow: hidden;
        height: 1.5rem;
        border-radius: 9999px;
        background-color: #d1d5db;
        cursor: pointer;
        transition: background-color 0.3s;
    }
    .toggle-checkbox:checked + .toggle-label {
        background-color: #00d4ff;
    }

    .profile-tab {
        padding: 0.75rem 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        color: #9ca3af;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
    }
    .profile-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }
    .profile-tab.active {
        background: rgba(0, 212, 255, 0.2);
        color: #00d4ff;
    }
</style>
</body>
</html>