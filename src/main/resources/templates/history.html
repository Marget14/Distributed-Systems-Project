<!DOCTYPE html>
<html layout:decorate="~{layout}" layout:fragment="content"
      xmlns:th="http://www.thymeleaf.org">
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl md:text-4xl font-display font-bold mb-2">Order History</h1>
        <p class="text-gray-600">Track, reorder, and manage your past orders</p>
    </div>

    <!-- Filters -->
    <div class="modern-card p-6 mb-8">
        <div class="flex flex-col md:flex-row md:items-center gap-4">
            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Time Period</label>
                <select class="modern-input py-3" onchange="filterOrders()">
                    <option value="all">All Orders</option>
                    <option value="month">This Month</option>
                    <option value="week">This Week</option>
                    <option value="today">Today</option>
                </select>
            </div>

            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select class="modern-input py-3" onchange="filterOrders()">
                    <option value="all">All Statuses</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                    <option value="refunded">Refunded</option>
                </select>
            </div>

            <div class="flex-1">
                <label class="block text-sm font-medium text-gray-700 mb-2">Sort By</label>
                <select class="modern-input py-3" onchange="filterOrders()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="price-low">Price: Low to High</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Order Count -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-display font-bold"><span id="order-count">12</span> orders found</h2>
        <div class="text-sm text-gray-600">
            Total spent: <span class="font-bold text-primary" id="total-spent">€327.45</span>
        </div>
    </div>

    <!-- Orders List -->
    <div class="space-y-6" id="orders-list">
        <!-- Orders will be loaded here -->
    </div>

    <!-- No Orders State -->
    <div id="no-orders" class="hidden">
        <div class="modern-card text-center p-12">
            <i class="fas fa-receipt text-6xl text-gray-300 mb-6"></i>
            <h3 class="text-xl font-display font-bold mb-4">No Orders Yet</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                You haven't placed any orders yet. Browse restaurants and place your first order!
            </p>
            <a href="/restaurants" class="modern-btn inline-block">
                <i class="fas fa-utensils mr-2"></i>Browse Restaurants
            </a>
        </div>
    </div>

    <!-- Pagination -->
    <div class="flex justify-center mt-12">
        <div class="flex gap-2">
            <button class="pagination-btn disabled">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button class="pagination-btn active">1</button>
            <button class="pagination-btn">2</button>
            <button class="pagination-btn">3</button>
            <button class="pagination-btn">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
</div>

<!-- Reorder Modal -->
<div id="reorder-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="modern-card w-full max-w-md">
            <div class="p-6">
                <h3 class="text-xl font-display font-bold mb-4">Reorder Items</h3>
                <div class="space-y-4 mb-6" id="reorder-items">
                    <!-- Items will be loaded here -->
                </div>

                <div class="flex gap-4">
                    <button onclick="hideReorderModal()" class="modern-btn-outline flex-1">
                        Cancel
                    </button>
                    <button onclick="confirmReorder()" class="modern-btn flex-1">
                        <i class="fas fa-redo mr-2"></i>Reorder
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Embedded JavaScript -->
<script>
    // Order history data
    const orders = [
        {
            id: 'ORD-98234761',
            date: '2024-01-15T12:05:00',
            restaurant: 'Burger Palace',
            items: [
                { name: 'Classic Burger', quantity: 2, price: 8.99 },
                { name: 'French Fries', quantity: 1, price: 3.99 },
                { name: 'Coca-Cola', quantity: 1, price: 2.50 }
            ],
            total: 26.97,
            status: 'delivered',
            rating: 5,
            deliveryAddress: 'Patission 76, Athens'
        },
        {
            id: 'ORD-98234760',
            date: '2024-01-14T19:30:00',
            restaurant: 'Sushi Master',
            items: [
                { name: 'Salmon Roll', quantity: 1, price: 12.50 },
                { name: 'Miso Soup', quantity: 1, price: 3.50 }
            ],
            total: 19.00,
            status: 'delivered',
            rating: 4,
            deliveryAddress: 'Patission 76, Athens'
        },
        {
            id: 'ORD-98234759',
            date: '2024-01-13T20:15:00',
            restaurant: 'Pizza Paradise',
            items: [
                { name: 'Margherita Pizza', quantity: 1, price: 10.99 },
                { name: 'Garlic Bread', quantity: 1, price: 4.50 }
            ],
            total: 18.49,
            status: 'cancelled',
            rating: null,
            deliveryAddress: 'Patission 76, Athens'
        },
        {
            id: 'ORD-98234758',
            date: '2024-01-10T13:45:00',
            restaurant: 'Greek Taverna',
            items: [
                { name: 'Greek Salad', quantity: 2, price: 8.50 },
                { name: 'Souvlaki', quantity: 1, price: 9.99 }
            ],
            total: 26.99,
            status: 'delivered',
            rating: 5,
            deliveryAddress: 'Patission 76, Athens'
        }
    ];

    let currentFilter = 'all';
    let currentReorderItems = null;

    // Initialize order history
    function initOrderHistory() {
        renderOrders();
        updateStats();

        // Setup pagination
        document.querySelectorAll('.pagination-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;

                document.querySelectorAll('.pagination-btn').forEach(b => {
                    b.classList.remove('active');
                });

                if (!this.querySelector('i')) {
                    this.classList.add('active');
                }

                // In a real app, this would load the selected page
                showToast('Pagination', 'Loading page...', 'info');
            });
        });
    }

    function renderOrders() {
        const container = document.getElementById('orders-list');
        const noOrders = document.getElementById('no-orders');
        const orderCount = document.getElementById('order-count');

        // Apply filters
        let filteredOrders = [...orders];

        if (currentFilter !== 'all') {
            // In a real app, apply actual filters
            // For demo, we'll just show all
        }

        if (filteredOrders.length === 0) {
            container.classList.add('hidden');
            noOrders.classList.remove('hidden');
            orderCount.textContent = '0';
            return;
        }

        container.classList.remove('hidden');
        noOrders.classList.add('hidden');
        orderCount.textContent = filteredOrders.length;

        // Render orders
        container.innerHTML = filteredOrders.map(order => `
            <div class="modern-card p-6">
                <div class="flex flex-col md:flex-row md:items-start gap-6">
                    <!-- Order Info -->
                    <div class="flex-1">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4 mb-4">
                            <div>
                                <div class="flex items-center gap-3 mb-2">
                                    <h3 class="text-xl font-display font-bold">${order.restaurant}</h3>
                                    ${getStatusBadge(order.status)}
                                </div>
                                <p class="text-gray-600">
                                    <i class="far fa-calendar mr-2"></i>
                                    ${formatDate(order.date)}
                                </p>
                                <p class="text-gray-600 text-sm mt-1">
                                    <i class="fas fa-map-marker-alt mr-2"></i>
                                    ${order.deliveryAddress}
                                </p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-display font-bold">€${order.total.toFixed(2)}</div>
                                <div class="text-sm text-gray-500">Order #${order.id}</div>
                            </div>
                        </div>

                        <!-- Order Items -->
                        <div class="space-y-3 mb-6">
                            ${order.items.map(item => `
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center">
                                            <i class="fas fa-utensils text-gray-400 text-xs"></i>
                                        </div>
                                        <div>
                                            <div>${item.name}</div>
                                            <div class="text-gray-500">Quantity: ${item.quantity}</div>
                                        </div>
                                    </div>
                                    <div class="font-medium">€${(item.price * item.quantity).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-3">
                            <button onclick="trackOrder('${order.id}')" class="modern-btn-outline">
                                <i class="fas fa-map-marker-alt mr-2"></i>Track
                            </button>
                            <button onclick="reorder('${order.id}')" class="modern-btn-outline">
                                <i class="fas fa-redo mr-2"></i>Reorder
                            </button>
                            ${order.status === 'delivered' ? `
                                <button onclick="rateOrder('${order.id}')" class="modern-btn-outline">
                                    ${order.rating ?
            `<i class="fas fa-star text-yellow-500 mr-2"></i>Rated (${order.rating}/5)` :
            `<i class="far fa-star mr-2"></i>Rate Order`
        }
                                </button>
                            ` : ''}
                            <button onclick="viewReceipt('${order.id}')" class="modern-btn-outline">
                                <i class="fas fa-receipt mr-2"></i>Receipt
                            </button>
                            ${order.status === 'delivered' ? `
                                <button onclick="getHelp('${order.id}')" class="modern-btn-outline">
                                    <i class="fas fa-question-circle mr-2"></i>Get Help
                                </button>
                            ` : ''}
                        </div>
                    </div>

                    <!-- Order Status Timeline -->
                    <div class="md:w-64">
                        <h4 class="font-display font-bold mb-4">Order Timeline</h4>
                        <div class="space-y-4">
                            <div class="timeline-step completed">
                                <div class="timeline-dot"></div>
                                <div>
                                    <div class="font-medium">Order Placed</div>
                                    <div class="text-sm text-gray-500">${formatTime(order.date)}</div>
                                </div>
                            </div>
                            <div class="timeline-step ${order.status !== 'cancelled' ? 'completed' : ''}">
                                <div class="timeline-dot"></div>
                                <div>
                                    <div class="font-medium">Preparing</div>
                                    <div class="text-sm text-gray-500">${formatTime(addMinutes(order.date, 5))}</div>
                                </div>
                            </div>
                            <div class="timeline-step ${order.status === 'delivered' ? 'completed' : ''}">
                                <div class="timeline-dot"></div>
                                <div>
                                    <div class="font-medium">On the Way</div>
                                    <div class="text-sm text-gray-500">
                                        ${order.status === 'delivered' ? formatTime(addMinutes(order.date, 25)) : '—'}
                                    </div>
                                </div>
                            </div>
                            <div class="timeline-step ${order.status === 'delivered' ? 'completed' : order.status === 'cancelled' ? 'cancelled' : ''}">
                                <div class="timeline-dot"></div>
                                <div>
                                    <div class="font-medium">
                                        ${order.status === 'delivered' ? 'Delivered' :
            order.status === 'cancelled' ? 'Cancelled' : 'Estimated Delivery'}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ${order.status === 'delivered' ? formatTime(addMinutes(order.date, 45)) :
            order.status === 'cancelled' ? formatTime(addMinutes(order.date, 10)) :
                formatTime(addMinutes(order.date, 45))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function updateStats() {
        const totalSpent = orders.reduce((sum, order) => {
            return order.status === 'delivered' ? sum + order.total : sum;
        }, 0);

        document.getElementById('total-spent').textContent = `€${totalSpent.toFixed(2)}`;
    }

    function getStatusBadge(status) {
        const badges = {
            'delivered': '<span class="status-badge status-delivered">Delivered</span>',
            'cancelled': '<span class="status-badge status-cancelled">Cancelled</span>',
            'refunded': '<span class="status-badge bg-purple-100 text-purple-800">Refunded</span>'
        };
        return badges[status] || '<span class="status-badge bg-gray-100 text-gray-800">Processing</span>';
    }

    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString('en-US', {
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function addMinutes(dateString, minutes) {
        const date = new Date(dateString);
        date.setMinutes(date.getMinutes() + minutes);
        return date;
    }

    // Action functions
    function trackOrder(orderId) {
        window.location.href = `/orders/${orderId}`;
    }

    function reorder(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order) return;

        currentReorderItems = order.items;

        // Show reorder modal
        const modal = document.getElementById('reorder-modal');
        const itemsContainer = document.getElementById('reorder-items');

        itemsContainer.innerHTML = order.items.map(item => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <div class="font-medium">${item.name}</div>
                    <div class="text-sm text-gray-500">Quantity: ${item.quantity}</div>
                </div>
                <div class="font-bold">€${(item.price * item.quantity).toFixed(2)}</div>
            </div>
        `).join('');

        modal.classList.remove('hidden');
    }

    function hideReorderModal() {
        document.getElementById('reorder-modal').classList.add('hidden');
    }

    function confirmReorder() {
        if (!currentReorderItems) return;

        // Clear current cart
        localStorage.removeItem('streetfoodgo-cart');

        // Add reorder items to cart
        const cartItems = currentReorderItems.map(item => ({
            id: `reorder-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
            name: item.name,
            restaurant: orders.find(o => o.items.includes(item))?.restaurant || 'Restaurant',
            price: item.price,
            quantity: item.quantity
        }));

        localStorage.setItem('streetfoodgo-cart', JSON.stringify(cartItems));

        hideReorderModal();
        showToast('Items added to cart', 'Your reorder items have been added to your cart', 'success');

        // Update cart badge
        const count = cartItems.reduce((total, item) => total + item.quantity, 0);
        document.getElementById('cart-badge').textContent = count;

        // Redirect to checkout
        setTimeout(() => {
            window.location.href = '/checkout';
        }, 1500);
    }

    function rateOrder(orderId) {
        const order = orders.find(o => o.id === orderId);
        if (!order) return;

        if (order.rating) {
            showToast('Already Rated', `You rated this order ${order.rating}/5 stars`, 'info');
            return;
        }

        // Show rating modal
        let rating = 0;
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
        modal.innerHTML = `
            <div class="modern-card p-8 max-w-sm">
                <h3 class="text-xl font-display font-bold mb-4">Rate Your Order</h3>
                <p class="text-gray-600 mb-6">How was your experience with ${order.restaurant}?</p>

                <div class="flex justify-center mb-6" id="rating-stars">
                    ${[1,2,3,4,5].map(i => `
                        <i class="far fa-star text-3xl text-gray-300 mx-1 cursor-pointer hover:text-yellow-500"
                           data-rating="${i}"
                           onmouseover="hoverStar(${i})"
                           onmouseout="resetStars()"
                           onclick="setRating(${i})"></i>
                    `).join('')}
                </div>

                <div class="text-center mb-6">
                    <span id="rating-text" class="text-gray-600">Tap to rate</span>
                </div>

                <div class="flex gap-4">
                    <button onclick="closeRating()" class="modern-btn-outline flex-1">
                        Cancel
                    </button>
                    <button onclick="submitRating('${orderId}')" class="modern-btn flex-1">
                        Submit
                    </button>
                </div>
            </div>
        `;

        document.body.appendChild(modal);

        // Rating functions
        window.hoverStar = function(star) {
            const stars = document.querySelectorAll('#rating-stars i');
            stars.forEach((s, i) => {
                if (i < star) {
                    s.className = 'fas fa-star text-3xl text-yellow-500 mx-1 cursor-pointer';
                } else {
                    s.className = 'far fa-star text-3xl text-gray-300 mx-1 cursor-pointer';
                }
            });

            const texts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('rating-text').textContent = texts[star - 1] || 'Tap to rate';
        };

        window.resetStars = function() {
            const stars = document.querySelectorAll('#rating-stars i');
            stars.forEach((s, i) => {
                if (i < rating) {
                    s.className = 'fas fa-star text-3xl text-yellow-500 mx-1 cursor-pointer';
                } else {
                    s.className = 'far fa-star text-3xl text-gray-300 mx-1 cursor-pointer';
                }
            });

            const texts = ['Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
            document.getElementById('rating-text').textContent = rating ? texts[rating - 1] : 'Tap to rate';
        };

        window.setRating = function(star) {
            rating = star;
            resetStars();
        };

        window.closeRating = function() {
            modal.remove();
        };

        window.submitRating = function(id) {
            if (rating === 0) {
                showToast('Please Rate', 'Select a rating before submitting', 'error');
                return;
            }

            // Update order rating
            const orderIndex = orders.findIndex(o => o.id === id);
            if (orderIndex !== -1) {
                orders[orderIndex].rating = rating;
            }

            modal.remove();
            showToast('Thank You!', `You rated this order ${rating}/5 stars`, 'success');

            // Re-render orders
            setTimeout(() => {
                renderOrders();
            }, 500);
        };
    }

    function viewReceipt(orderId) {
        showToast('Receipt', `Downloading receipt for order ${orderId}...`, 'info');
        // In a real app, this would generate/download a PDF receipt
    }

    function getHelp(orderId) {
        showToast('Get Help', `Opening help center for order ${orderId}...`, 'info');
        // In a real app, this would open a help form or chat
    }

    function filterOrders() {
        // In a real app, this would filter orders based on selected filters
        showToast('Filter Applied', 'Orders filtered based on your selection', 'success');
        renderOrders();
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initOrderHistory();
    });
</script>

<style>
    .timeline-step {
        display: flex;
        align-items: flex-start;
        gap: 12px;
        position: relative;
    }

    .timeline-step:not(:last-child)::before {
        content: '';
        position: absolute;
        left: 11px;
        top: 24px;
        bottom: -28px;
        width: 2px;
        background: #e2e8f0;
    }

    .timeline-step.completed:not(:last-child)::before {
        background: var(--primary);
    }

    .timeline-dot {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #e2e8f0;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
    }

    .timeline-step.completed .timeline-dot {
        background: var(--primary);
    }

    .timeline-step.cancelled .timeline-dot {
        background: var(--danger);
    }

    .pagination-btn {
        width: 40px;
        height: 40px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .pagination-btn:hover:not(.disabled) {
        border-color: var(--primary);
        color: var(--primary);
    }

    .pagination-btn.active {
        background: var(--primary);
        border-color: var(--primary);
        color: white;
    }

    .pagination-btn.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
</html>